"use strict";(self.webpackChunkstreamlit_geomap_frontend=self.webpackChunkstreamlit_geomap_frontend||[]).push([[6500],{6500:(e,t,n)=>{n.d(t,{FeatureSnappingEngine:()=>N});var r=n(35143),i=n(91967),o=n(18690),l=n(54901),a=n(81806),s=n(98773),u=n(94643),d=n(50346),c=n(68134);function p(e,t,n){var r,i;const o=null!==(r=null===n||void 0===n||null===(i=n.createCollection)||void 0===i?void 0:i.call(n))&&void 0!==r?r:new u.A,l=null!==n&&void 0!==n&&n.recycleItems?new v:null,a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null===e||void 0===e||!e.length)return;const n=o.splice(t,e.length);l?l.processRemoved(e):n.forEach(f)},s=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null===e||void 0===e||!e.length)return;const r=[];for(const i of e){const e=null===l||void 0===l?void 0:l.use(i);if(e)r.push(e);else{const e=t(i);null!==l&&void 0!==l&&l.register(i,e),r.push(e)}}o.addMany(r,n)},d=(0,c.on)(e,"after-splice",e=>{let{added:t,start:n,removed:r}=e;a(r,n),s(t,n)},{sync:!0,onListenerRemove:e=>a(e.items),onListenerAdd:e=>s(e.items)});return o.addHandles(d),o}class v{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(null===e||void 0===e||!e.length)return;const{_removedItemCandidates:t}=this;for(const r of e){var n;(null===(n=this._getItem(r))||void 0===n?void 0:n.markRemoved())&&(t.add(r),this._queueGarbageCollection())}}use(e){const t=this._getItem(e);return t&&(t.removed=!1),null===t||void 0===t?void 0:t.item}register(e,t){this._originalToMapped.set(e,new h(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,n=this._getItem(e);(null===n||void 0===n?void 0:n.removed)&&(f(n.item),t.delete(e))}}class h{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function f(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():(0,l.wt)(e))}var y=n(31633),g=n(46053),m=n(76460),S=n(85842),_=n(19555),w=n(20664),b=n(9392),F=n(53494),M=n(19451),R=n(12482),C=n(75543),I=n(23862),A=n(89379),x=n(34154),E=(n(47249),n(8203)),L=n(46530),T=n(31933),Z=n(70330),G=n(90992);let H=class extends i.A{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){var e;return null===(e=this.view)||void 0===e||null===(e=e.allLayerViews)||void 0===e?void 0:e.find(e=>e.layer===this.layer)}get valid(){const{_valid:e,snappingSource:t,layer:n}=this;return!(!t||!n)&&e}get subtypeFilter(){var e,t,n;const{layer:r,snappingSource:i}=this;if(!(0,T.F2)(r)||null===(e=r.subtypes)||void 0===e||!e.length||!i)return{mode:"not-in-use",filter:null};const o=i.layerSource.sublayerSources.filter(e=>{var t;return e.enabled&&e.layer.visible&&(0,G.JU)(null===(t=this.view)||void 0===t?void 0:t.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)}).map(e=>e.layer.subtypeCode);if(!o.length)return{mode:"none-visible",filter:null};if(o.length===r.subtypes.length)return{mode:"all-visible",filter:null};const l=null!==(t=null===(n=r.fieldsIndex.get(r.subtypeField))||void 0===n?void 0:n.name)&&void 0!==t?t:r.subtypeField;return 1===o.length?{mode:"in-use",filter:"".concat(l," = ").concat(o.getItemAt(0))}:{mode:"in-use",filter:"".concat(l," IN (").concat(o.join(", "),")")}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?(0,L.E)({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:t}=this;if("refresh"in e){const n=e;this.addHandles(n.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([(0,c.wB)(()=>t.updating,e=>t.layerSource.updating=e,c.pc),(0,c.wB)(()=>t.availability,e=>t.layerSource.availability=e,c.pc)])}getFetchCandidatesParameters(e,t,n){var r,i,o,l,s;if(!this.valid)return[];const{layer:u,layerView:d,floorFilter:c,rulesTable:p,subtypeFilter:v}=this,h=(0,A.A)((0,A.A)({distance:n,mode:null!==(r=null===(i=this.view)||void 0===i?void 0:i.type)&&void 0!==r?r:"2d",point:e,coordinateHelper:t.coordinateHelper},{returnEdge:!0,vertexMode:"all"}),{},{filter:d&&"filter"in d?d.filter:null});if(c&&(h.filter=z(h.filter,c)),"not-in-use"!==v.mode&&"all-visible"!==v.mode){if("none-visible"===v.mode)return[];h.filter?h.filter.where=(0,x.mA)(h.filter.where,v.mode):h.filter=new E.A({where:v.filter})}if(!this.attributeRulesEnabled)return[h];const f=t.feature,y="subtype-sublayer"===(null===f||void 0===f||null===(o=f.sourceLayer)||void 0===o?void 0:o.type)?f.sourceLayer.parent:null===f||void 0===f?void 0:f.sourceLayer;if(p&&f&&(0,Z.Tu)(null===(l=this.view)||void 0===l?void 0:l.map)&&((0,T.yZ)(u)||(0,T.F2)(u))&&((0,T.yZ)(y)||(0,T.F2)(y))&&null!==(s=this.view.map.utilityNetworks)&&void 0!==s&&s.find(e=>e.isUtilityLayer(y))){var g,m;if("loaded"!==p.loadStatus)return[];const e=[],t=u.layerId,n=null===(g=p.getFeatureSQL(y,f))||void 0===g?void 0:g[t];if(!n)return[];const r=n.anyVertex;let i=n.endVertex;return i&&r&&i===r&&(i=""),i&&e.push((0,A.A)((0,A.A)({},h),{},{returnEdge:!1,vertexMode:"ends",filter:z(h.filter,i)})),r&&e.push((0,A.A)((0,A.A)({},h),{},{returnEdge:null!==(m=(0,a.A)("snapping-include-edges-when-applying-any-vertex-rule"))&&void 0!==m&&m,vertexMode:"all",filter:z(h.filter,r)})),e}return[h]}async loadRules(){this._valid=null;const{layer:e,view:t,attributeRulesEnabled:n}=this;if(n&&e&&t&&(0,Z.Tu)(null===t||void 0===t?void 0:t.map)&&((0,T.yZ)(e)||(0,T.F2)(e)))try{var r,i,o,l;await Promise.allSettled(null!==(r=null===(i=t.map.utilityNetworks)||void 0===i?void 0:i.map(e=>e.load()))&&void 0!==r?r:[]);const n=null===(o=t.map.utilityNetworks)||void 0===o?void 0:o.find(t=>t.isUtilityLayer(e));n&&(this.rulesTable=await n.getRulesTable(),await(null===(l=this.rulesTable)||void 0===l?void 0:l.load()))}catch(h){return this._valid=!1,void m.A.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){var e;null===(e=this.snappingSource)||void 0===e||e.destroy()}};function z(e,t){return null==e?new E.A({where:t}):e.where?new E.A({where:(0,x.mA)(e.where,t)}):new E.A({where:t})}(0,r._)([(0,g.MZ)({constructOnly:!0})],H.prototype,"layer",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],H.prototype,"snappingSource",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],H.prototype,"view",void 0),(0,r._)([(0,g.MZ)({value:!1})],H.prototype,"attributeRulesEnabled",null),(0,r._)([(0,g.MZ)()],H.prototype,"layerView",null),(0,r._)([(0,g.MZ)()],H.prototype,"rulesTable",void 0),(0,r._)([(0,g.MZ)()],H.prototype,"valid",null),(0,r._)([(0,g.MZ)()],H.prototype,"subtypeFilter",null),(0,r._)([(0,g.MZ)()],H.prototype,"floorFilter",null),(0,r._)([(0,g.MZ)()],H.prototype,"_valid",void 0),H=(0,r._)([(0,S.$)("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],H);var O=n(99791),P=n(80794),j=n(9876),V=n(61751),D=n(78228),k=n(17072);let N=class extends i.A{get updating(){return this._snappingSources.some(e=>{var t;return null==(null===e||void 0===e?void 0:e.valid)||!0===e.valid&&!0===(null===(t=e.snappingSource)||void 0===t?void 0:t.updating)})||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=O.n.FEATURE,this._updatingHandles=new M.U,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=function(e,t,n){const r=new u.A,i=p(e,e=>(0,s.UT)(async n=>{const r=await t(e,n);if((0,d.G4)(n))throw f(r),(0,d.NK)();return r}),n),o=()=>null,a=async e=>{const t=await e.promise,n=i.indexOf(e);n<0||r.splice(n,1,t)};r.addMany(i.items.map(o));for(const l of i)(0,d.QZ)(a(l));const c=i.on("after-splice",e=>{let{added:t,start:n,deleteCount:i}=e;const l=r.splice(n,i);for(const r of l)f(r);if(null!==t&&void 0!==t&&t.length){r.addMany(t.map(o),n);for(const e of t)(0,d.QZ)(a(e))}});return r.addHandles([(0,l.DQ)(i),c]),r}(()=>{var e;return null===(e=this.options)||void 0===e?void 0:e._effectiveFeatureSources},(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([(0,l.DQ)(e),(0,c.wB)(()=>{var e;return{rulesEnabled:!(null===(e=this.options)||void 0===e||!e.attributeRulesEnabled),sources:this._snappingSources.filter(o.Ru)}},e=>{let{rulesEnabled:t,sources:n}=e;for(const r of n)r.attributeRulesEnabled=t},c.OH)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,n,r){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const i=[],o=this._computeScreenSizeDistanceParameters(e,n);for(const u of this._snappingSources){var l,a;if(null===u||void 0===u||!u.valid||null===(l=u.snappingSource)||void 0===l||null===(l=l.layerSource)||void 0===l||!l.enabled||null!==(a=u.layerView)&&void 0!==a&&a.suspended)continue;const t=u.getFetchCandidatesParameters(e,n,o);for(const e of t)i.push(u.snappingSource.fetchCandidates(e,r).then(e=>e.filter(e=>!this._candidateIsExcluded(u.snappingSource,e,n.excludeFeature))))}const s=(await(0,d.nA)(i)).flat();return this._addRightAngleCandidates(s,e,o,n),(0,d.Te)(r),(0,Z.xX)(e,s),s}_addRightAngleCandidates(e,t,n,r){var i,o,l,a;const s=null!=r.vertexHandle?null===(i=r.vertexHandle.rightEdge)||void 0===i||null===(i=i.rightVertex)||void 0===i?void 0:i.pos:null!=r.editGeometryOperations&&"polygon"===r.editGeometryOperations.data.type?null===(o=r.editGeometryOperations.data.components[0])||void 0===o||null===(o=o.getFirstVertex())||void 0===o?void 0:o.pos:null,u=null!=r.vertexHandle?null===(l=r.vertexHandle.leftEdge)||void 0===l||null===(l=l.leftVertex)||void 0===l?void 0:l.pos:null!=r.editGeometryOperations?null===(a=r.editGeometryOperations.data.components[0])||void 0===a||null===(a=a.getLastVertex())||void 0===a?void 0:a.pos:null,{view:d}=this,c=(0,I.Lp)(s,d,r),p=(0,I.Lp)(u,d,r),v=e.length;for(let h=0;h<v;h++)this._addRightAngleCandidate(e[h],p,t,n,e),this._addRightAngleCandidate(e[h],c,t,n,e)}_addRightAngleCandidate(e,t,n,r,i){if(null==t||!function(e){return(e instanceof j.z||e instanceof P.X)&&!function(e){let{constraint:{start:t,end:n}}=e;const r=(0,w.s)(t,n),i=(0,_.hG)((0,I.Xz)(t),(0,I.Xz)(n));return r<(0,F.FD)()||i/r<q}(e)}(e))return;const o=e.constraint.closestTo(t),l=(o[0]-n[0])/r.x,a=(o[1]-n[1])/r.y,{start:s,end:u}=e.constraint;if(l*l+a*a<=1){const n=(0,_.hG)((0,I.Xz)(o),(0,I.Xz)(s))>(0,_.hG)((0,I.Xz)(o),(0,I.Xz)(u))?s:u,r=new D.HJ({targetPoint:(0,I.de)(o),otherVertex:t,otherVertexType:D.pn.NEXT,previousVertex:n,constraint:new C.FX(t,o),objectId:e.objectId,isDraped:e.isDraped,domain:O.n.FEATURE});i.push(r)}}_computeScreenSizeDistanceParameters(e,t){let n=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:n,y:n,z:n,distance:n}:"2d"===this.view.type?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,n,r){const{spatialReference:i}=r;n.renderCoordsHelper.toRenderCoords(e,i,Q);const o=n.state.camera.computeScreenPixelSizeAt(Q),l=o*n.renderCoordsHelper.unitInMeters,a=l/(0,y.GA)(i),s=l/(0,y.G9)(i),u=t*a,d=t*s,c=(0,k.j)(e,i,R.qt,n),p=c?X(c,e,a,0,0,n,r):0,v=c?X(c,e,0,a,0,n,r):0,h=c?X(c,e,0,0,s,n,r):0;return{x:0===p?0:u/p,y:0===v?0:u/v,z:0===h?0:d/h,distance:o*t}}_candidateIsExcluded(e,t,n){if(null==n)return!1;const r=this._getCandidateObjectId(t);if(null==r)return!1;const i=e.layerSource.layer;return"graphics"===i.type?n.uid===r:n.sourceLayer===i&&!(!n.attributes||!("objectIdField"in i))&&n.attributes[i.objectIdField]===r}_getCandidateObjectId(e){return e instanceof V.w?e.objectId:null}async _createSourceInfo(e,t){const n=e.layer;n.loaded||(await n.load(),(0,d.Te)(t));const{view:r}=this,i=await this._createFeatureSnappingSourceType(e);return(0,d.Te)(t),new H(null==i?{}:{snappingSource:i,view:r,layer:n})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return null==t||"3d"!==t.type?null:new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch(null===(t=e.layer.source)||void 0===t?void 0:t.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return"mesh"===e.layer.geometryType?null:new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>{var t,n;return null!==(t=null===(n=e.layer.sublayers)||void 0===n?void 0:n.toArray())&&void 0!==t?t:[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),n={module:null,loader:t};this._sourceModules[e]=n;const r=await t,i={module:r,loader:t};return this._sourceModules[e]=i,r}return null==t.module?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(n.e(1927).then(n.bind(n,51927)));case"featureCollection":return t.addPromise(n.e(7567).then(n.bind(n,77567)));case"graphics":case"notes":return t.addPromise(Promise.all([n.e(8683),n.e(2003),n.e(4439),n.e(8094),n.e(6e3),n.e(9546)]).then(n.bind(n,99546)));case"scene":return t.addPromise(Promise.all([n.e(8105),n.e(2259),n.e(1929)]).then(n.bind(n,91929)))}}get test(){}};function X(e,t,n,r,i,o,l){let{spatialReference:a}=l;const s=(0,w.c)(U,t);s[0]+=n,s[1]+=r,s[2]+=i;const u=(0,k.j)(s,a,R.qt,o);return u?(0,Z.Mo)(u,e):1/0}(0,r._)([(0,g.MZ)({constructOnly:!0})],N.prototype,"spatialReference",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],N.prototype,"view",void 0),(0,r._)([(0,g.MZ)()],N.prototype,"options",void 0),(0,r._)([(0,g.MZ)({readOnly:!0})],N.prototype,"updating",null),(0,r._)([(0,g.MZ)()],N.prototype,"_snappingSources",void 0),N=(0,r._)([(0,S.$)("esri.views.interactive.snapping.FeatureSnappingEngine")],N);const Q=(0,b.vt)(),U=(0,b.vt)(),q=1e-4},46530:(e,t,n)=>{function r(e){var t;const n=e.layer;return"floorInfo"in n&&null!==(t=n.floorInfo)&&void 0!==t&&t.floorField&&"floors"in e.view?o(e.view.floors,n.floorInfo.floorField):null}function i(e,t){var n;return"floorInfo"in t&&null!==(n=t.floorInfo)&&void 0!==n&&n.floorField?o(e,t.floorInfo.floorField):null}function o(e,t){if(null===e||void 0===e||!e.length)return null;const n=e.filter(e=>""!==e).map(e=>"'".concat(e,"'"));return n.push("''"),"".concat(t," IN (").concat(n.join(","),") OR ").concat(t," IS NULL")}n.d(t,{E:()=>r,f:()=>i})}}]);
//# sourceMappingURL=6500.db8eae1f.chunk.js.map