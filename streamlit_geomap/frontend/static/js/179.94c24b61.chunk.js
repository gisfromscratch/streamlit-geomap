"use strict";(self.webpackChunkstreamlit_geomap_frontend=self.webpackChunkstreamlit_geomap_frontend||[]).push([[179],{2257:(e,t,i)=>{i.d(t,{D8:()=>n,TO:()=>s,d0:()=>a});var r=i(53430);async function s(e){var t,i;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.popupTemplate;if(null==s)return[];const n=await s.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:a}=s,{objectIdField:o,typeIdField:l,globalIdField:h,relationships:d}=e;if(n.includes("*"))return["*"];const c=a?(0,r.eX)(e):[],u=(0,r.DB)(e.fieldsIndex,[...n,...c]);return l&&u.push(l),u&&o&&null!==(t=e.fieldsIndex)&&void 0!==t&&t.has(o)&&!u.includes(o)&&u.push(o),u&&h&&null!==(i=e.fieldsIndex)&&void 0!==i&&i.has(h)&&!u.includes(h)&&u.push(h),d&&d.forEach(t=>{var i;const{keyField:r}=t;u&&r&&(null===(i=e.fieldsIndex)||void 0===i?void 0:i.has(r))&&!u.includes(r)&&u.push(r)}),u}function n(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}function a(e,t){return null!=n(e,{defaultPopupTemplateEnabled:t})}},9612:(e,t,i)=>{i.d(t,{p:()=>r});i(17345);function r(e){return null!=e.mapPositions}},10708:(e,t,i)=>{i.d(t,{H:()=>l});var r,s=i(57528),n=i(65058),a=i(86955),o=i(4653);function l(e){e.include(n.E),e.uniforms.add(new o.x("geometryDepthTexture",e=>{var t;return null===(t=e.geometryDepth)||void 0===t?void 0:t.attachment})),e.code.add((0,a.H)(r||(r=(0,s.A)(["bool geometryDepthTest(vec2 pos, float elementDepth) {\nfloat geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);\nreturn (elementDepth < (geometryDepth - 1.0));\n}"]))))}},11687:(e,t,i)=>{i.d(t,{$:()=>r});class r{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}}},24947:(e,t,i)=>{i.d(t,{U:()=>m});var r=i(69539),s=(i(81806),i(76460)),n=i(9392),a=i(55855),o=i(5262),l=i(48989),h=i(67425),d=i(49296),c=i(41595),u=i(36423),p=i(41854),y=i(75646),g=i(63048);const v=()=>s.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class m extends y.x{constructor(e,t,i,r){let s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];super(i.schedule),this.symbol=e,this.symbolLayer=t,this._context=i,this._drivenOpacityFallbackAlwaysOpaque=s,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=v(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new d.F,this.updateComplexity(),this.ignoreDrivers=r.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=b(this._context.renderer,s)),this._updateElevationContext()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get usedMemory(){const e=this.complexity;return null==e?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,i=b(e,this._drivenOpacityFallbackAlwaysOpaque);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size||i.rotation!==t.rotation}get needsDrivenTransparentPass(){return(this._drivenProperties.color||this._drivenProperties.opacity)&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const s=e.projectionSuccess,n="polygons"in e?e.polygons:null,a="".concat(r," geometry failed to be created");s?!this._logGeometryValidationWarnings(t,i,r)&&n&&0===n.length&&"rings"===i&&t.length>0&&t[0].length>2&&v().warnOncePerTick("".concat(a," (filled rings should use clockwise winding - try reversing the order of vertices)")):v().warnOncePerTick("".concat(a," (failed to project geometry to view spatial reference)"))}updateFocus(e,t){}_logGeometryValidationWarnings(e,t,i){const r="".concat(i," geometry failed to be created");return!e.length||1===e.length&&!e[0].length?(v().warnOncePerTick("".concat(r," (no ").concat(t," were defined)")),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(v().warnOncePerTick("".concat(r," (").concat(t," should be defined as a 2D array)")),!0)}_validateGeometry(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+" symbol: ".concat(e.type)),!1;switch(e.type){case"point":{const t=e;if(!isFinite(t.x)||!isFinite(t.y))return v().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":(0,o.m3)(e)}return!0}_defaultElevationInfoNoZ(){return _}_defaultElevationInfoZ(){return f}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultElevationInfo(e);return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e){var t,i;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new d.F;const s=e.geometry,n=this.getDefaultElevationInfo(s);r.unit=null!=this._elevationContext.unit?this._elevationContext.unit:n.unit,r.mode=this.getGeometryElevationMode(s,n),r.offsetMeters=null!==(t=null!==(i=this._elevationContext.meterUnitOffset)&&void 0!==i?i:n.offset)&&void 0!==t?t:0;const a=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===r.mode;a&&(r.mode="relative-to-ground",r.offsetMeters=0);const o=a?c.KF:this._elevationContext.featureExpressionInfoContext;return r.updateFeatureExpressionInfoContext(o,e,this._context.layer),r}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,i,r){return!1}onRemoveGraphic(e){}_getLayerOpacity(){var e;if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return null!==(e=this._context.graphicsCoreOwner.fullOpacity)&&void 0!==e?e:0;const t=this._context.layer.opacity;return null!==t&&void 0!==t?t:1}_getCombinedOpacity(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S;const i=this.draped?1:this._getLayerOpacity();return this._drivenProperties.opacity||this._drivenProperties.color?i:e?i*e.a:t.hasIntrinsicColor?i:0}_getCombinedOpacityAndColor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S;const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return(0,u.$C)(null,i);const s=null!=e?r.A.toUnitRGB(e):n.Un;return(0,u.$C)(s,i)}_getVertexOpacityAndColor(e,t){var i,r;let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const n=this._drivenProperties.color?null!==(i=e.color)&&void 0!==i?i:t:null,a=this._drivenProperties.opacity?null!==(r=e.opacity)&&void 0!==r?r:t[3]:null,o=(0,u.$C)(n,a);return s&&(o[0]*=s,o[1]*=s,o[2]*=s,o[3]*=s),o}isFastUpdatesEnabled(){return null!=this._fastUpdates}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return(0,l.JV)(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==h.uw.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,i){let r=h.uw.UPDATE;return null!==e&&void 0!==e&&e.forEach(e=>{const s=t(e);if(null!=s){const t=e.graphic;this.setGraphicElevationContext(t,s.elevationContext),s.needsElevationUpdates=i(s.elevationContext.mode)}else r=h.uw.RECREATE}),r}applyRendererDiff(e,t){return p.w.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,i=t.size?(0,g.ul)(t.size.field,e):0,r=t.color?(0,g.ul)(t.color.field,e):0,s=t.opacity?(0,g.ul)(t.opacity.field,e):0;return(0,a.fA)(i,r,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&v().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>{var e,t,i,r,s,n,a,o;return{size:null!==(e=null===(t=this._fastUpdates)||void 0===t||null===(t=t.visualVariables.size)||void 0===t?void 0:t.field)&&void 0!==e?e:null,color:null!==(i=null===(r=this._fastUpdates)||void 0===r||null===(r=r.visualVariables.color)||void 0===r?void 0:r.field)&&void 0!==i?i:null,opacity:null!==(s=null===(n=this._fastUpdates)||void 0===n||null===(n=n.visualVariables.opacity)||void 0===n?void 0:n.field)&&void 0!==s?s:null,rotation:null!==(a=null===(o=this._fastUpdates)||void 0===o||null===(o=o.visualVariables.rotation)||void 0===o?void 0:o.field)&&void 0!==a?a:null}}}}}function b(e,t){const i={color:!1,opacity:!1,opacityAlwaysOpaque:t,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(e=>{switch(e.type){case"color":if(i.color=!0,e.stops)for(let t=0;t<e.stops.length;t++){const r=e.stops[t].color;r&&r.a<1&&(i.opacityAlwaysOpaque=!1)}break;case"opacity":i.opacity=!0,i.opacityAlwaysOpaque=!1;break;case"size":i.size=!0;break;case"rotation":i.rotation=!0}}),i}const _={mode:"on-the-ground",offset:0,unit:"meters"},f={mode:"absolute-height",offset:0,unit:"meters"},S={hasIntrinsicColor:!1}},28350:(e,t,i)=>{i.d(t,{Z:()=>r});class r{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.labelText=t,this.elevationOffset=null!==e&&void 0!==e?e:0}}},29308:(e,t,i)=>{i.d(t,{B6:()=>y,G8:()=>g,Jf:()=>m,Zd:()=>b});var r=i(34761),s=i(13191),n=i(20664),a=i(9392),o=i(5809),l=i(45308),h=i(67425),d=i(22955),c=i(80935),u=i(9612),p=i(66470);function y(e,t,i,r,s){const n=e.stageObject,a=n.geometries;let o=0;for(const l of a){if(!(0,u.p)(l))continue;const{update:e,averageGeometrySampledElevation:a}=P(l,t,i,r,s);o+=a,e&&n.geometryVertexAttributeUpdated(l,p.r.POSITION)}return o/a.length}function g(e,t,i,s,a,l){const c=e.stageObject,u=t.centerPointInElevationSR;let p=0;c.usesVerticalDistanceToGround?(s(u,E),(0,h.ai)(c,E.verticalDistanceToGround),p=E.sampledElevation):(s(u,E),"absolute-height"!==t.mode&&(p=E.sampledElevation));const y=(0,r.C)(v,null!==l&&void 0!==l?l:c.transformation),g=(0,n.i)(x,y[12],y[13],y[14]);d.b.TESTS_DISABLE_OPTIMIZATIONS?(f[0]=u.x,f[1]=u.y,f[2]=E.z,(0,o.l)(u.spatialReference,f,y,a.spatialReference)&&(l?(0,r.C)(l,y):c.transformation=y)):a.setAltitudeOfTransformation(E.z,y);const m=_/a.unitInMeters;return(Math.abs(y[12]-g[0])>=m||Math.abs(y[13]-g[1])>=m||Math.abs(y[14]-g[2])>=m)&&(l?(0,r.C)(l,y):c.transformation=y),p}const v=(0,s.vt)();function m(e,t,i,r,s){const a=e.graphics3DSymbolLayer.lodRenderer;if(null==a)return 0;const l=t.centerPointInElevationSR;r(l,E);const h="absolute-height"!==t.mode?E.sampledElevation:0,c=a.instanceData,u=e.instanceIndex,p=w;c.getGlobalTransform(u,p);const y=(0,n.i)(x,p[12],p[13],p[14]);d.b.TESTS_DISABLE_OPTIMIZATIONS?(f[0]=l.x,f[1]=l.y,f[2]=E.z,(0,o.l)(l.spatialReference,f,p,s.spatialReference)&&c.setGlobalTransform(u,p)):s.setAltitudeOfTransformation(E.z,p);const g=_/s.unitInMeters;return(d.b.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(p[12]-y[0])>=g||Math.abs(p[13]-y[1])>=g||Math.abs(p[14]-y[2])>=g)&&c.setGlobalTransform(u,p),h}function b(e,t,i,r,s){const n=e.stageObject,a=n.geometries;if(0===a.length)return 0;let o=0,l=null,h=0,d=!1;for(const c of a){if(!(0,u.p)(c))continue;const e=c.attributes.get(p.r.POSITION);if(e!==l){const{update:n,averageGeometrySampledElevation:a}=P(c,t,i,r,s);h=a,l=e,d=n}d&&n.geometryVertexAttributeUpdated(c,p.r.POSITION),o+=h}return o/a.length}const _=.01,f=(0,a.vt)(),S=(0,a.vt)(),C=(0,a.vt)(),w=(0,s.vt)(),x=(0,a.vt)(),E=new h.Uk;function P(e,t,i,r,s){let n=!1;const a=e.transformation,o=t.requiresSampledElevationInfo;S[0]=a[12],S[1]=a[13],S[2]=a[14],e.invalidateBoundingInfo();const h=e.getMutableAttribute(p.r.POSITION),u=h.data,y=h.size,g=u.length/y,v=new c.aY(e.mapPositions,i);let m=0,b=0;for(let c=0;c<g;c++){if(C[0]=u[m],C[1]=u[m+1],C[2]=u[m+2],r(v,E),o&&(b+=E.sampledElevation),d.b.TESTS_DISABLE_OPTIMIZATIONS)u[m]=v.array[v.offset],u[m+1]=v.array[v.offset+1],u[m+2]=E.z,(0,l.projectBuffer)(u,i,m,u,s.spatialReference,m,1),u[m]-=S[0],u[m+1]-=S[1],u[m+2]-=S[2],n=!0;else{f[0]=u[m]+S[0],f[1]=u[m+1]+S[1],f[2]=u[m+2]+S[2],s.setAltitude(f,E.z),u[m]=f[0]-S[0],u[m+1]=f[1]-S[1],u[m+2]=f[2]-S[2];const e=_/s.unitInMeters;(Math.abs(C[0]-u[m])>=e||Math.abs(C[1]-u[m+1])>=e||Math.abs(C[2]-u[m+2])>=e)&&(n=!0)}m+=y,v.offset+=3}return b/=g,{update:n,averageGeometrySampledElevation:b}}},33376:(e,t,i)=>{i.d(t,{T:()=>s});var r=i(20176);const s={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new r.Om(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>e.ensureCentroid(t)}},38865:(e,t,i)=>{i.d(t,{qD:()=>s,r4:()=>n});var r=i(55855);const s=1.2,n=r.uY},40179:(e,t,i)=>{i.r(t),i.d(t,{default:()=>xr});var r=i(35143),s=i(50076),n=i(30726),a=i(68134),o=i(46053),l=i(81806),h=i(76460),d=(i(47249),i(85842)),c=i(54901),u=i(50346),p=i(47700);const y=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,p.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,c.hA)(()=>e.abort())),await(0,a.C_)(()=>{var e;return null===(e=this.view.defaultsFromMap)||void 0===e?void 0:e.heightModelInfoReady},t),(0,u.Te)(t);const i=(0,p.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,r._)([(0,o.MZ)()],t.prototype,"view",void 0),(0,r._)([(0,o.MZ)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,r._)([(0,d.$)("esri.views.3d.layers.LayerView3D")],t),t};var g=i(9392),v=i(13312),m=i(64232),b=i(18117),_=i(12482),f=i(67425),S=i(49296),C=i(41595);var w=i(89379),x=i(39356),E=i(91967),P=i(15011),G=i(19451),A=i(25515),O=i(32535),L=i(86486),I=i(97015),R=i(57662),D=i(38865),F=i(18690),T=i(87663),M=i(79369),U=i(30015),V=i(52394),z=i(20664),j=i(76797),B=i(19247),H=i(9956),N=i(45308),k=i(14487),Z=i(91789),q=i(42294),W=i(2413),Y=i(80963),Q=i(99784),$=i(84031),X=i(35039),J=i(87708);function K(e){return null==e||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function ee(e,t){if(null==e)return null;if(!K(e))return new s.A("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '".concat(e.type||e.declaredClass,"'"),{renderer:e});switch(e.type){case"simple":return function(e,t){const i=(0,w.A)((0,w.A)((0,w.A)({},J.c),t),{},{cimFallbackEnabled:!0});return te(e,(0,J.t)(e.symbol,i).error)}(e,t);case"unique-value":return function(e,t){var i;const r=(0,w.A)((0,w.A)((0,w.A)({},J.c),t),{},{cimFallbackEnabled:!0}),s=null===(i=e.uniqueValueInfos)||void 0===i?void 0:i.map(e=>(0,J.t)(e.symbol,r).error).filter(F.Ru),n=(0,J.t)(e.defaultSymbol,r);return n.error&&null!==s&&void 0!==s&&s.unshift(n.error),te(e,s)}(e,t);case"class-breaks":return function(e,t){const i=(0,w.A)((0,w.A)((0,w.A)({},J.c),t),{},{cimFallbackEnabled:!0}),r=e.classBreakInfos.map(e=>(0,J.t)(e.symbol,i).error).filter(F.Ru),s=(0,J.t)(e.defaultSymbol,i);return s.error&&r.unshift(s.error),te(e,r)}(e,t);case"dictionary":case"heatmap":return null}return null}function te(e,t){if(!t)return null;if(Array.isArray(t)||(t=[t]),t.length>0){const i=t.map(e=>e.details.symbol.type||e.details.symbol.declaredClass).filter(e=>!!e);i.sort();const r=new Array;return i.forEach((e,t)=>{0!==t&&e===i[t-1]||r.push(e)}),new s.A("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols (".concat(r.join(", "),") which are not supported in 3D"),{renderer:e,symbolErrors:t})}return null}var ie=i(11687),re=i(86300),se=i(76386),ne=i(16911),ae=i(86659),oe=i(89579),le=i(46265),he=i(48989);class de{constructor(e,t,i){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=i}}i(66388);var ce,ue,pe=i(59752);class ye{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,i){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,s){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,i,r)}}!function(e){e[e.USER=1]="USER",e[e.SCALE_RANGE=2]="SCALE_RANGE",e[e.FILTER=4]="FILTER",e[e.DECONFLICTION=8]="DECONFLICTION",e[e.ALL_GRAPHIC=15]="ALL_GRAPHIC",e[e.ALL_LABEL=255]="ALL_LABEL"}(ce||(ce={})),function(e){e[e.GRAPHIC=1]="GRAPHIC",e[e.LABEL=16]="LABEL"}(ue||(ue={}));var ge=i(54099),ve=i(20176),me=i(1484),be=i(33376);const _e=(0,q.vt)();let fe=class extends E.A{constructor(e){super(e),this.events=new ge.A,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:be.T.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:be.T.getAttributes(e),getObjectId:e=>{var t;return"graphic"in e?null!==(t=(0,Q.RW)(e.graphic,this.objectIdField))&&void 0!==t?t:void 0:be.T.getObjectId(e)},getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):be.T.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;null!=e.centroid?i=e.centroid:"point"===e.graphic.geometry.type&&(0,H.projectPoint)(e.graphic.geometry,Se,this.viewSpatialReference)&&(i=Se);const r=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return null==i?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=i.x,r[1]=i.y,t.hasZ&&(r[2]=i.hasZ?i.z:0),t.hasM&&(r[t.hasZ?3:2]=i.hasM?i.m:0)),new me.A([],r)}return be.T.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new ve.Om(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):be.T.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){const i=this.getSpatialIndex();for(const r of e){const e=this.featureAdapter.getObjectId(r);null!=i.getBounds(e,_e)&&t(_e)}}};(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"getSpatialIndex",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"forEach",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"hasZ",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"hasM",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"objectIdField",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"viewSpatialReference",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],fe.prototype,"featureSpatialReference",void 0),fe=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],fe);const Se={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};class Ce{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}var we=i(64465);class xe{constructor(e,t,i,r){this.scheduler=e,this.schedule=t,this.layerViewUid=i,this.compressionTracker=r,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===we.RT.Global}}var Ee=i(98773),Pe=i(82041),Ge=i(69539),Ae=i(76931),Oe=i(55855),Le=i(29308),Ie=i(99057),Re=i(28350),De=i(24947),Fe=i(36423),Te=i(88265),Me=i(90346),Ue=i(50468),Ve=i(17345),ze=i(66470),je=i(57528),Be=i(88685),He=i(59422),Ne=i(48549),ke=i(34981),Ze=i(59696),qe=i(45463),We=i(77730),Ye=i(52757),Qe=i(16506),$e=i(59246),Xe=i(40431),Je=i(93345),Ke=i(57162);class et extends $e.w{constructor(e,t){super(e,t,new Qe.$(Xe.L,()=>i.e(9873).then(i.bind(i,99873))))}initializePipeline(e){const{hudDepth:t,terrainDepthTest:i}=e,r={func:i?Je.MT.ALWAYS:Je.MT.LESS};return(0,Ke.Ey)(t?{depthTest:r,depthWrite:Ke.Uy}:{blending:(0,Ke.p3)(Je.dn.ONE,Je.dn.SRC_ALPHA,Je.dn.ONE_MINUS_SRC_ALPHA,Je.dn.ONE_MINUS_SRC_ALPHA),depthTest:r,colorWrite:Ke.kn})}}var tt=i(6485),it=i(92656);class rt extends it.E{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}}(0,r._)([(0,tt.W)()],rt.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r._)([(0,tt.W)()],rt.prototype,"occlusionTestEnabled",void 0),(0,r._)([(0,tt.W)()],rt.prototype,"hasVerticalOffset",void 0),(0,r._)([(0,tt.W)()],rt.prototype,"hasScreenSizePerspective",void 0),(0,r._)([(0,tt.W)()],rt.prototype,"hudDepth",void 0),(0,r._)([(0,tt.W)()],rt.prototype,"hudDepthAlignStart",void 0),(0,r._)([(0,tt.W)()],rt.prototype,"terrainDepthTest",void 0);var st,nt=i(75569);class at extends qe.im{constructor(e,t){super(e,ht),this.intersectDraped=void 0,this.produces=new Map([[We.N.LINE_CALLOUTS,e=>(0,ke.RN)(e)],[We.N.LINE_CALLOUTS_HUD_DEPTH,e=>(0,ke.RN)(e)]]),this._configuration=new rt(t),this._uniqueMaterialIdentifier=ot(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=t.slot===We.N.LINE_CALLOUTS_HUD_DEPTH,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){var e,t;return this.parameters.color[3]>=nt.Q||(null!==(e=null===(t=this.parameters.borderColor)||void 0===t?void 0:t[3])&&void 0!==e?e:0)>=nt.Q}intersect(){}createGLMaterial(e){return new lt(e)}createBufferWriter(){return new ut}validateParameters(e){this._uniqueMaterialIdentifier=ot(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function ot(e){let{renderOccluded:t,isDecoration:i,horizontalScreenOffset:r,color:s,size:n,occlusionTest:a,shaderPolygonOffset:o,hudDepthAlignStart:l,centerOffsetUnits:h,hasSlicePlane:d,screenSizePerspective:c,verticalOffset:u,borderColor:p}=e;return(0,Be.ML)(st||(st=(0,je.A)(["",":",":",":[","]:",":",":",":",":",":",":",":{",":",":","}:[","]"])),t,i,r,s,n,a,o,l,h,d,null!=c,u.screenLength,u.minWorldLength,u.maxWorldLength,p)}class lt extends Ze.A{beginSlot(e){return this.getTechnique(et,e)}}class ht extends qe.qA{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=(0,Oe.fA)(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const dt=(0,Ne.BP)().vec3f(ze.r.POSITION).vec3f(ze.r.NORMAL).vec2f16(ze.r.UV0).vec4f(ze.r.CENTEROFFSETANDDISTANCE),ct=[(0,He.fA)(0,0),(0,He.fA)(1,0),(0,He.fA)(0,1),(0,He.fA)(1,0),(0,He.fA)(1,1),(0,He.fA)(0,1)];class ut{constructor(){this.vertexBufferLayout=dt}elementCount(e){return 6*e.get(ze.r.POSITION).indices.length}write(e,t,i,r,s,n){(0,Ye.Hk)(i.get(ze.r.POSITION),e,s.position,n,6),(0,Ye.p1)(i.get(ze.r.NORMAL),t,s.normal,n,6),(0,Ye.Ut)(i.get(ze.r.CENTEROFFSETANDDISTANCE),s.centerOffsetAndDistance,n,6);for(let a=0;a<ct.length;++a)s.uv0.setVec(n+a,ct[a]);return null}}var pt=i(34017);class yt extends De.U{constructor(e,t){super(e,null,t,mt),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new at(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){var t;const i=this._materialParameters;return i.horizontalScreenOffset=null!==(t=e.horizontalScreenOffset)&&void 0!==t?t:0,i.centerOffsetUnits=e.centerOffsetUnits||"world",i}get _materialParameters(){var e;const t=new ht,i=this.symbol,r=i.callout;if(r.color){const e=Ge.A.toUnitRGBA(r.color);e[3]*=this._getLayerOpacity(),t.color=e}else t.color=Oe.uY;if(t.size=(0,Ae.Lz)(r.size||0),i.verticalOffset){const{screenLength:e,minWorldLength:r,maxWorldLength:s}=i.verticalOffset;t.verticalOffset={screenLength:(0,Ae.Lz)(e),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}t.borderColor=null!=(null===(e=r.border)||void 0===e?void 0:e.color)?Ge.A.toUnitRGBA(r.border.color):null;const s="object"===i.symbolLayers.at(0).type,n="label-3d"===i.type;return t.occlusionTest=!s&&!(0,l.A)("enable-feature:non-occluded-hud"),s&&(t.shaderPolygonOffset=0),t.hudDepthAlignStart=n,t.hasSlicePlane=this._context.slicePlaneEnabled,t.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,t}_defaultElevationInfoNoZ(){return vt}createGraphics3DGraphic(e,t){const i=e.renderingInfo,r=e.graphic,s=this.setGraphicElevationContext(r,new S.F,i.elevationOffset||0),n=i.symbol,a="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some(e=>"object"===e.type||"text"===e.type));if("label-3d"!==n.type&&a)return null;if("point-3d"===n.type&&n.symbolLayers.every(e=>"text"===e.type&&!(0,Pe.Ie)(e)))return null;const o=(0,Fe.W$)(r.geometry);return null==o?null:this._createAs3DShape(o,s,i,r.uid,t)}layerOpacityChanged(){var e;null===(e=this._materials[0])||void 0===e||e.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=(0,f.I2)(yt.elevationModeChangeTypes,i,r);return s!==f.uw.UPDATE||null!==e&&void 0!==e&&e.forEach(e=>{const i=t(e);null!=i&&this.updateGraphicElevationContext(e.graphic,i)}),s}slicePlaneEnabledChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(i),t}updateGraphicElevationContext(e,t){var i;const{elevationContext:r,metadata:s}=t;this.setGraphicElevationContext(e,r,null!==(i=null===s||void 0===s?void 0:s.elevationOffset)&&void 0!==i?i:0),t.needsElevationUpdates=(0,f.nu)(r.mode)}computeComplexity(){return new Me.rz({verticesPerFeature:6})}_getOrCreateMaterial(e,t){var i;const r=this._perInstanceMaterialParameters(e),s=ot(r);if(s===(null===(i=this._materials[0])||void 0===i?void 0:i.uniqueMaterialIdentifier))return this._materials[0];if(t){let e=t.get(s);return null==e&&(e=new at(r,this._context.spherical),t.set(s,e)),e}return new at(r,this._context.spherical)}_createAs3DShape(e,t,i,r,s){const n=this._context.layerViewUid,a=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:n}),o=this._getOrCreateMaterial(i,s),l=new Ve.V(o,function(e){const{translation:t,centerOffset:i}=e,r=new Ue.n(t?[t[0],t[1],t[2]]:[0,0,0],gt,3,!0),s=new Ue.n(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],gt,4,!0);return[[ze.r.POSITION,r],[ze.r.NORMAL,new Ue.n([0,0,1],gt,3,!0)],[ze.r.CENTEROFFSETANDDISTANCE,s]]}(i),null,pt.d.Point,a),h=(0,Te.SZ)(this._context,e,l,t,r);if(null==h)return null;const d=new Ie.Y(this,h.object,null,Le.G8,t);return d.metadata=new Re.Z(i.elevationOffset),d.alignedSampledElevation=h.sampledElevation,d.needsElevationUpdates=(0,f.nu)(t.mode),(0,Te.d2)(d,e,this._context.elevationProvider),d}}yt.elevationModeChangeTypes={definedChanged:f.uw.UPDATE,staysOnTheGround:f.uw.UPDATE,onTheGroundChanged:f.uw.RECREATE};const gt=[0],vt={mode:"relative-to-ground",offset:0},mt={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class bt extends ie.${constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,g.vt)(),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,Oe.vt)(),s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"world",a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;super(e,t),this.translation=i,this.centerOffset=r,this.horizontalScreenOffset=s,this.centerOffsetUnits=n,this.elevationOffset=a}}const _t=()=>h.A.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");const ft={line:yt};var St=i(97255),Ct=i(3789),wt=i(19555),xt=i(72745),Et=i(65215);function Pt(e,t,i,r){return null!=e&&((0,Y.aI)(t,r)?((0,W.C)(i,e),!0):(Gt[0]=e[0],Gt[1]=e[1],Gt[2]=0,!!(0,N.projectBuffer)(Gt,t,0,Gt,r,0)&&(i[0]=Gt[0],i[1]=Gt[1],Gt[0]=e[2],Gt[1]=e[3],Gt[2]=0,!!(0,N.projectBuffer)(Gt,t,0,Gt,r,0)&&(i[2]=Gt[0],i[3]=Gt[1],!0))))}const Gt=(0,g.vt)();var At=i(98618);const Ot=new Ct.A(Array,e=>(0,q.hZ)(e,q.v_),null,10,5),Lt=(0,W.vt)();class It{get labelLayers(){return this._labelLayers||F.tR}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>null===e||void 0===e?void 0:e.isElevationSource)}constructor(e,t,i,r,s){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=ce.ALL_LABEL,++t.referenced,this._featureExpressionFeature=s?(0,C.VG)(s,e,r):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(ue.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{"draped"===t.type&&(e=!0)}),e}isVisible(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ue.GRAPHIC,t=arguments.length>1?arguments[1]:void 0;const i=t?this._visibleFlags|t|ue.LABEL*t:this._visibleFlags;return e===ue.GRAPHIC?(i&ce.ALL_GRAPHIC)===ce.ALL_GRAPHIC:(i&ce.ALL_LABEL)===ce.ALL_LABEL}setVisibilityFlag(e,t,i){const r=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const s=this.isVisible(e);if(r===s)return!1;if(e===ue.LABEL)this._forEachLabelGraphic(e=>e.setVisibility(s));else{this._forEachSymbolLayerGraphic(e=>e.setVisibility(s));const e=this.isVisible(ue.LABEL);this._forEachLabelGraphic(t=>t.setVisibility(e))}return!0}getVisibilityFlag(e,t){return 0!==(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=(0,W.vt)(),(0,Q.iQ)(t,this._extent);const i=t.spatialReference;if(!(0,Y.aI)(i,e)&&!Pt(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=Et.A.fromExtent("mesh"===r.type?r.extent:r)),(0,At.Ux)(r,t,i)}get usedMemory(){let e=(0,St.lM)(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){const e={render:{origin:(0,g.vt)(),num:0},draped:{origin:(0,xt.vt)(),num:0}};for(const t of this.layers)null!=t&&t.computeAttachmentOrigin(e);return e.render.num>1&&(0,z.g)(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&(0,wt.hs)(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,s){return s||(s={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),s.boundingBox?(0,q.Ie)(s.boundingBox):s.boundingBox=(0,q.Ie)(),s.requiresDrapedElevation=!1,await(0,Ee.jJ)(this.layers,async n=>{if(null==n)return;const a="draped"===n.type?t:e,o=Ot.acquire(),l=await n.getProjectedBoundingBox(a,i,s.screenSpaceObjects,r,o);isFinite(l[2])&&isFinite(l[5])||(s.requiresDrapedElevation=!0),l&&(0,q.RF)(s.boundingBox,o),Ot.release(o)}),(0,q.vQ)(s.boundingBox)||(0,W.vQ)((0,q.ES)(s.boundingBox,Lt))?s:null}needsElevationUpdates(){var e,t;for(const i of this.layers)if(null!=i&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0;return null!==(e=null===(t=this._labelLayers)||void 0===t?void 0:t.some(e=>{var t;return null!==(t=null===e||void 0===e?void 0:e.needsElevationUpdates)&&void 0!==t&&t}))&&void 0!==e&&e}alignWithElevation(e,t,i){this._forEachRenderedGraphic(r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)})}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic(r=>{"object3d"===r.type&&r.alignWithAbsoluteElevation(e,t,i)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){null===e||void 0===e||e.forEach(e=>e&&t(e))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}}var Rt=i(41854),Dt=i(75646);function Ft(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes}class Tt extends Dt.x{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,i)=>{const r=this.symbolLayers[i];null!=r&&(r.symbol=e,r.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const r=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const s=[],{make:n}=await Promise.all([i.e(4439),i.e(4712),i.e(5011),i.e(1821),i.e(8699),i.e(9513),i.e(443)]).then(i.bind(i,79144));for(let i=0;i<r;i++){const a=t.at(i);if(!1===a.enabled)continue;Mt.renderPriority=1-(1+i)/r,Mt.renderPriorityStep=1/r,Mt.ignoreDrivers=a.ignoreDrivers;const o=n(this.symbol,a,this._context,Mt),l=(0,u.NY)(e,()=>{this.symbolLayers[i]=null,o.destroy()});l&&s.push(l),this.symbolLayers[i]=o}if(await(0,Ee.jJ)(this.symbolLayers,async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch(i){this.symbolLayers[t]=null}}),s.forEach(e=>e.remove()),(0,u.Te)(e),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>null===e||void 0===e?void 0:e.queryForSnapping)}updateFocus(e,t){this.symbolLayers.forEach(i=>null===i||void 0===i?void 0:i.updateFocus(e,t))}createGraphics3DGraphic(e,t){var i;const r=e.graphic,s=this.symbolLayers.map(t=>{var i;return null!==(i=null===t||void 0===t?void 0:t.createGraphics3DGraphic(e))&&void 0!==i?i:null}),n=this._context.arcade||(null===(i=this._context.featureExpressionInfoContext)||void 0===i||null===(i=i.arcade)||void 0===i?void 0:i.modules)||null;return new It(r,t||this,s,e.layer,n)}get complexity(){return(0,he.Tf)(this.symbolLayers.map(e=>null!=e?e.complexity:null))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],s=e=>{const t=e.layers[r];return t instanceof Ie.Y?t:null};if(null!=i&&!i.globalPropertyChanged(e,t,s))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==Dt.P.LOADED?Rt.w.RecreateSymbol:this.symbolLayers.reduce((i,r)=>i!==Rt.w.RecreateSymbol&&null!=r?Math.min(i,r.applyRendererDiff(e,t)):i,Rt.w.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===Dt.P.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach((t,r)=>{if(null==t)return;const s=i[r];if(s){const i={diff:s,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{const s=e.layers[r];null!=s&&i.graphics3DGraphicPatches.forEach(e=>e(s,t))})}})}updateGeometry(e,t){return this._updateGeometryOrTransform(e,(e,i)=>e.updateGeometry(i,t))}updateTransform(e,t,i,r){return this._updateGeometryOrTransform(e,(e,s)=>e.updateTransform(s,t,i,r))}_updateGeometryOrTransform(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(null==r)continue;const s=e.layers[i];if(!s||!t(r,s))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(null==i)continue;const r=e.layers[t];null!=r&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(const i of this.symbolLayers)if(null!=i){if(i.loadStatus===Dt.P.LOADING)return Rt.G.Loading;i.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?Rt.G.Mixed:Rt.G.Fast:e?Rt.G.Slow:Rt.G.Undefined}async queryForSnapping(e,t,i,r){const s=this.symbolLayers.filter(F.Ru).filter(e=>null!=e.queryForSnapping).map(s=>s.queryForSnapping(e,t,i,r)),n=await Promise.all(s);return(0,u.Te)(r),n.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return Ft(this)}}const Mt=new class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class Ut extends Tt{constructor(e,t,i){super(e,t,i),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=function(e,t){if(!(0,Pe.YX)(e))return _t().error("Graphics3DCalloutSymbolLayerFactory#make","symbol of type '".concat(e.type,"' does not support callouts")),null;if(!e.callout)return null;const i=ft[e.callout.type];return i?new i(e,t):(_t().error("Graphics3DCalloutSymbolLayerFactory#make","unknown or unsupported callout type ".concat(e.callout.type)),null)}(this.symbol,t))}async doLoad(e){const t=this._calloutSymbolLayer?(0,Ee.Ke)(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),(0,u.Te)(e)}catch(y){var i;throw null!==(i=this._calloutSymbolLayer)&&void 0!==i&&i.abortLoad(),y}t&&await t}destroy(){super.destroy(),this._calloutSymbolLayer=(0,n.pR)(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){const i=super.createGraphics3DGraphic(e,t);if(null!=this._calloutSymbolLayer&&null!=i){const t=this._createCalloutGraphic(e);t&&i.setCalloutGraphic(t)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,e=>e.calloutLayer))}updateGeometry(e,t){const i=super.updateGeometry(e,t);if(i&&this._calloutSymbolLayer){const i=e.calloutLayer;if(i)return this._calloutSymbolLayer.updateGeometry(i,t)}return i}_createCalloutGraphic(e){const t=e.renderingInfo;return e.renderingInfo=new bt(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}}class Vt extends Dt.x{constructor(e,t,i){super(t),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:he.uD}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):Rt.w.RecreateSymbol}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,i,r){var s,n;return null!==(s=null===(n=this.graphics3DSymbol)||void 0===n?void 0:n.updateTransform(e,t,i,r))&&void 0!==s&&s}onRemoveGraphic(){}updateFocus(){}getFastUpdateStatus(){var e,t;return null!==(e=null===(t=this.graphics3DSymbol)||void 0===t?void 0:t.getFastUpdateStatus())&&void 0!==e?e:Rt.G.Loading}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}get cachedMemory(){return Ft(this)}}class zt{constructor(e,t,i,r){this.total=e,this.visible=t,this.missing=i,this.pending=r}}class jt{constructor(e){var t;this._graphicsCore=e,this._idToState=new Map,this._states=new Set;const i=null===(t=e.owner.layer)||void 0===t?void 0:t.objectIdField;i?(this._getGraphicId=e=>(0,Q.RW)(e,i),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach((e,t)=>this.remove(t))}add(e){const t=(0,c.hA)(()=>this.remove(e));if(this._states.has(e))return t;const i=this._getGraphicId(e.graphic),r=this._getGraphics3DGraphicById(i);return this._states.has(e)||this._states.add(e),this._ensureStateList(i).push(e),e.displaying=null!=r&&r.isVisible(),e.isDraped=null!=r&&r.isDraped,e.tracking=!0,null!=r&&e.emit("changed"),t}remove(e){if(this._states.has(e)){if(this._idToState.size){const t=this._getGraphicId(e.graphic),i=this._idToState.get(t);i&&((0,F.TF)(i,e),0===i.length&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e.graphic,t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")})}removeGraphic(e){this._forEachState(e.graphic,e=>{e.displaying=!1,e.isDraped=!1})}updateGraphicGeometry(e){this._forEachState(e.graphic,e=>e.emit("changed"))}updateGraphicVisibility(e){this._forEachState(e.graphic,t=>t.displaying=e.isVisible())}updateGraphicError(e,t){this._forEachState(e,e=>e.error=t)}allGraphicsDeleted(){this._states.forEach(e=>e.displaying=!1)}_ensureStateList(e){const t=this._idToState.get(e);if(t)return t;const i=new Array;return this._idToState.set(e,i),i}_forEachState(e,t){if(0===this._states.size||0===this._idToState.size)return;const i=this._getGraphicId(e),r=this._idToState.get(i);null!=r&&r.forEach(t)}}var Bt=i(70373);let Ht=class extends E.A{constructor(e){super(e),this._index=new Bt.w(9,(0,l.A)("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=(0,n.pR)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,i){null!=t&&t.equals(this.spatialReference)&&(Nt.minX=e[0],Nt.minY=e[1],Nt.maxX=e[2],Nt.maxY=e[3],this.update(),this._index.search(Nt,e=>i(e.graphic.uid)))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);if(!e.extent)return;this._index.remove(e);const t=(0,Q.RW)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=(0,Q.RW)(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){Nt.minX=e[0],Nt.minY=e[1],Nt.maxX=e[2],Nt.maxY=e[3],this.update(),this._index.search(Nt,e=>{t(e)})}getBounds(e,t){this.update();const i=this._boundsByFeature.get(e);return i?(0,q.Jt)(t,i):null}};(0,r._)([(0,o.MZ)({constructOnly:!0})],Ht.prototype,"spatialReference",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],Ht.prototype,"hasZ",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],Ht.prototype,"hasM",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],Ht.prototype,"objectIdField",void 0),(0,r._)([(0,o.MZ)()],Ht.prototype,"updating",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],Ht.prototype,"updatingRemaining",null),Ht=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.SpatialIndex2D")],Ht);const Nt={minX:0,minY:0,maxX:0,maxY:0};var kt=i(31633),Zt=i(59097);var qt=i(29808),Wt=i(3112);const Yt=Symbol("layerHandles");let Qt=class extends(ge.A.EventedMixin(E.A)){get spatialReference(){var e;return null===(e=this.view)||void 0===e?void 0:e.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new qt.n(this.view.state.viewingMode),this._intersector.options.store=Wt.o.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],e=>this._objectChanged(e)),t.on(["geometryAdded","geometryRemoved"],e=>{let{object:t}=e;return this._objectChanged(t)}),t.on("attributesChanged",e=>{let{attribute:t,object:i}=e;return(0,ze.b)(t)&&this._objectChanged(i)})],Yt)}dispose(){this.removeHandles(Yt)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t,i;const r=(0,kt.G9)(this.layer.spatialReference),s=(0,Zt.Ao)(null!==(t=e.unit)&&void 0!==t?t:"meters");this._elevationOffset=(null!==(i=e.offset)&&void 0!==i?i:0)*s/r}else this._elevationOffset=0}getElevation(e,t,i,r){if(Jt[0]=e,Jt[1]=t,Jt[2]=i,!this._renderCoordsHelper.toRenderCoords(Jt,r,Jt))return h.A.getLogger(this).error("could not project point for elevation alignment"),null;const s=this._elevationOffset,n=this._zmin+s,a=this._zmax+s;this._renderCoordsHelper.setAltitude(Kt,a,Jt),this._renderCoordsHelper.setAltitude(ei,n,Jt);return this._intersector.reset(Kt,ei,null),this._intersector.intersect(this._intersectLayers,null,1,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(Jt)?this._renderCoordsHelper.getAltitude(Jt):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;(0,q.Ie)($t);const i=e.lastValidElevationBB;i.isEmpty()||this._expandExtent(t,i.min,i.max,$t);const{min:r,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,s,$t),(0,q.ES)($t,Xt.extent),this._zmin=Math.min(this._zmin,$t[2]),this._zmax=Math.max(this._zmax,$t[5]),Xt.spatialReference=t,this.emit("elevation-change",Xt),(0,z.c)(i.min,r),(0,z.c)(i.max,s)}_computeLayerExtent(e,t){return(0,q.Ie)($t),null!=e&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,$t)),$t}_expandExtent(e,t,i,r){for(let s=0;s<8;++s)Jt[0]=1&s?t[0]:i[0],Jt[1]=2&s?t[1]:i[1],Jt[2]=4&s?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(Jt,Jt,e),(0,q.iT)(r,Jt);return r}};(0,r._)([(0,o.MZ)({constructOnly:!0})],Qt.prototype,"layer",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],Qt.prototype,"stageLayer",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],Qt.prototype,"view",void 0),(0,r._)([(0,o.MZ)()],Qt.prototype,"spatialReference",null),Qt=(0,r._)([(0,d.$)("esri.views.3d.layers.support.StageLayerElevationProvider")],Qt);const $t=(0,q.Ie)(),Xt=new class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"scene";this.context=e,this.extent=(0,W.Ie)()}},Jt=(0,g.vt)(),Kt=(0,g.vt)(),ei=(0,g.vt)();const ti=(0,g.vt)();var ii=i(97583),ri=i(44513),si=i(8918),ni=i(2257),ai=i(5890),oi=i(75540);class li{constructor(){this._pendingCompressionTasks=(0,oi.v)(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}}var hi,di,ci=i(22856);const ui=(0,g.vt)(),pi=(0,q.vt)();let yi=(hi=class extends E.A{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){var e;return this._spatialIndex||(this._spatialIndex=new Ht({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){var e;return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?ri.q.ASYNC:null!==(e=this._forcedUpdatePolicy)&&void 0!==e?e:this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){var e,t,i;return!!(this.dataUpdating||null!==(e=this._elevationAlignment)&&void 0!==e&&e.updating||null!==(t=this._scaleVisibility)&&void 0!==t&&t.updating||null!==(i=this._filterVisibility)&&void 0!==i&&i.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this._updateQueue.updating||this.running)}get dataUpdating(){var e;return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||null!==(e=this._spatialIndex)&&void 0!==e&&e.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.updating||this._loadingSymbols>0||this.compressionTracker.compressing)}get running(){var e;return this._pendingUpdates.size>0||!(null===(e=this._spatialIndex)||void 0===e||!e.updating)||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){var e;return this.owner.suspended||!(null===(e=this.owner.suspendInfo)||void 0===e||!e.outsideOfView)}get updatingRemaining(){var e,t;return this.updating?this._pendingUpdates.size+.1*((null===(e=this._spatialIndex)||void 0===e?void 0:e.updatingRemaining)||0)+.1*((null===(t=this._elevationAlignment)||void 0===t?void 0:t.updatingRemaining)||0):0}get displayFeatureLimit(){var e,t,i,r,s;const n=this.owner&&this.owner.view&&this.owner.view.qualitySettings,a=null!==(e=null===n||void 0===n?void 0:n.graphics3D.minTotalNumberOfFeatures)&&void 0!==e?e:0,o=null!==(t=null===n||void 0===n?void 0:n.graphics3D.maxTotalNumberOfFeatures)&&void 0!==t?t:0,l=null!==(i=null===n||void 0===n?void 0:n.graphics3D.maxNumberOfDrawCalls)&&void 0!==i?i:0,h=null!==(r=null===n||void 0===n?void 0:n.graphics3D.maxTotalNumberOfVertices)&&void 0!==r?r:0,d=this.averageSymbolComplexity,c=Math.max(1,null!==(s=null===d||void 0===d?void 0:d.verticesPerFeature)&&void 0!==s?s:1),u=d&&d.drawCallsPerFeature>0&&l>0?l/d.drawCallsPerFeature:o,p=Math.ceil(h/c),y=Math.max(a,Math.min(o,p,u)),g=this._get("displayFeatureLimit");return g&&g.maximumTotalNumberOfVertices===h&&g.averageSymbolComplexity===d&&g.maximumNumberOfFeatures===y?g:new de(h,y,d)}get averageSymbolComplexity(){const e=(0,he.k9)(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||null!=t&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){var e,t;const i=this.labelsEnabled?(null!==(e=null===(t=this.averageSymbolComplexity)||void 0===t?void 0:t.memory.bytesPerFeatureLabel)&&void 0!==e?e:0)*this._numberOfGraphics:0,r=this._getSymbolComplexitiesUsed().reduce((e,t)=>e+t.memory.resourceBytes,0);if(null==this._symbolMaterials){this._symbolMaterials=[];for(const e of this._symbols.values())if(null!=e)for(const t of e.symbolLayers)if(t)for(const e of t.materials)e&&this._symbolMaterials.push(e)}const s=this.owner.view.stage.renderer,n=this.owner.view.basemapTerrain.overlayManager.renderer,a=this._symbolMaterials.reduce((e,t)=>{var i,r;return e+(null!==(i=null===(r=s.getMaterialRenderer(t)||n.getMaterialRenderer(t))||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)},0);return this._usedMemory+i+r+a}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(null!=this.averageSymbolComplexity){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){var t,i;const r=e;if("web-style"===r.type)return r.clone();const s=this._symbolConversionCache.get(r.id);if(null!=s)return s;const n=(0,J.t)(r,{geometryType:null!==(t=null===(i=this.layer)||void 0===i?void 0:i.geometryType)&&void 0!==t?t:void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(r),cimFallbackEnabled:!0}),a=n.symbol||null;return null==a&&n.error&&h.A.getLogger(this).error(n.error.message),this._symbolConversionCache.set(r.id,a),a}_getSymbolComplexitiesUsedOrRenderer(e){if(null==e)return[];const t=e.symbols,i="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!i&&!t.length)return[];const r=[],s=this._getSymbolComplexityUsedOrRenderer(i);null!=s&&r.push(s);for(const n of t){const e=this._getSymbolComplexityUsedOrRenderer(n);null!=e&&r.push(e)}return r}_getSymbolComplexityUsedOrRenderer(e){if(null==e)return null;const t=this._symbols.get(e.id);if(null!=t)return t.complexity;const i=this._getConvertedSymbol(e);return null!=i?(0,he.Eg)(i):null}_getSymbolComplexitiesUsed(){const e=[];return this._symbols.forEach(t=>{null!=t&&e.push(t.complexity)}),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new ai.M({computedExtent:j.A},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=pe.nu,this._dataUpdateQueue=new $.T,this._updateQueue=new $.T,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new U.A({allocator:e=>e||new vi,deallocator:e=>(e.clear(),e)}),this.compressionTracker=new li,this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new U.A,this.preferredUpdatePolicy=ri.q.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",e=>e.destroy()),this.symbolCreationContext=new xe(e.owner.view.resourceController.scheduler,(e,t)=>this._updateQueue.push(e,t),e.owner.layerViewUid,this.compressionTracker)}initialize(){var e,t,i,r,s,n,o;this._featureStore=new fe({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});const l=(e,t,i)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,i),{componentFactories:h}=this;this._elevationAlignment=null===(t=h.elevationAlignment)||void 0===t?void 0:t.call(h,this,l),this._scaleVisibility=null===(i=h.scaleVisibility)||void 0===i?void 0:i.call(h,this,l),this._filterVisibility=null===(r=h.filterVisibility)||void 0===r?void 0:r.call(h,{featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(ue.GRAPHIC,ce.FILTER,e((0,Q.RW)(t.graphic,this._objectIdField)))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(ue.GRAPHIC,ce.FILTER,e)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(ue.GRAPHIC,ce.FILTER,!0))}),this._deconflictor=null===(s=h.deconflictor)||void 0===s?void 0:s.call(h,this),this._labeler=null===(n=h.labeler)||void 0===n?void 0:n.call(h,this,this._scaleVisibility),this._objectStates=null===(o=h.objectStates)||void 0===o?void 0:o.call(h,this),this._initializeAbortController=new AbortController,this.addHandles((0,a.z7)(()=>this.owner.view.state.highlights,()=>{const{highlightOrderMap:e}=this.owner.view.state;this.graphics3DGraphics.forEach(t=>t.updateHighlights(e))})),this._initializePromise=this._initializeAsync()}async _initializeAsync(){var e,t,i;const r=null===(e=this._initializeAbortController)||void 0===e?void 0:e.signal,s=this.owner.view;this._viewElevationProvider=new ye(this._viewSpatialReference,s),this._initializeStage(s,this.owner.layerViewUid);const n=s.sharedSymbolResources;this.symbolCreationContext.sharedResources=n,this._sharedSymbolResourcesOwnerHandle=n.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=n.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=s.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new ii.g(s.renderSpatialReference),this.symbolCreationContext.elevationProvider=s.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const o=(0,C.MF)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await(0,C.q6)(o,this._viewSpatialReference,r,h.A.getLogger(this)),(0,u.Te)(r),this.symbolCreationContext.screenSizePerspectiveEnabled=s.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!(null===(t=this.owner.view.qualitySettings)||void 0===t||!t.physicallyBasedRenderingEnabled),this.symbolCreationContext.skipHighSymbolLods=!(null===(i=this.owner.view.qualitySettings)||void 0===i||null===(i=i.graphics3D)||void 0===i||!i.skipHighSymbolLods),"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=s.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this.addHandles((0,c.hA)(()=>s.basemapTerrain.overlayManager.unregisterDrapeSource(e)))}this.addHandles([(0,a.wB)(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(u.QZ)),(0,a.wB)(()=>{var e,t;return[null===(e=this.layer)||void 0===e?void 0:e.screenSizePerspectiveEnabled,null===(t=this.owner.view)||void 0===t?void 0:t.screenSizePerspectiveEnabled]},()=>{var e;const t=s.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;t!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=t,null!==(e=this._labeler)&&void 0!==e&&e.reset(),this.recreateAllGraphicsAndSymbols())}),(0,a.wB)(()=>this.owner.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(!!e)),(0,a.wB)(()=>{var e;return null===(e=this.owner.view.state)||void 0===e?void 0:e.rasterPixelRatio},()=>this._pixelRatioChange()),(0,a.wB)(()=>{var e;return!(null===(e=this.owner.view.qualitySettings)||void 0===e||!e.physicallyBasedRenderingEnabled)},e=>this._physicalBasedRenderingChange(e)),(0,a.wB)(()=>{var e;return!(null===(e=this.owner.view.qualitySettings)||void 0===e||null===(e=e.graphics3D)||void 0===e||!e.skipHighSymbolLods)},e=>this._skipHighSymbolLoDsChange(e)),(0,a.wB)(()=>{var e;return null===(e=this.owner.view.focusAreasView)||void 0===e?void 0:e.polygons},()=>this._updateFocusedLabels()),(0,a.wB)(()=>{var e;return null===(e=this.owner.view.map)||void 0===e?void 0:e.focusAreas.style},()=>this.recreateAllGraphicsAndSymbols()),(0,a.z7)(()=>{var e;return null===(e=s.basemapTerrain)||void 0===e?void 0:e.tilingScheme},e=>{if(e.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==s.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=s.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>{var e;return null===(e=this.owner)||void 0===e?void 0:e.loadedGraphics};this.addHandles([(0,a.on)(e,"change",e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}},{initial:!0}),(0,a.wB)(()=>this.effectiveUpdatePolicy,e=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===ri.q.ASYNC,e===ri.q.SYNC&&this.runTask(pe.Bb)},a.pc)]),this._frameTaskHandle=s.resourceController.scheduler.registerTask(pe.W6.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles((0,a.wB)(()=>this.layer.featureReduction,()=>{var e;return null===(e=this._deconflictor)||void 0===e?void 0:e.featureReductionChange()})),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch(()=>{}),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController=(0,n.DC)(this._initializeAbortController)}_updateFocusedLabels(){this.forEachGraphics3DSymbol((e,t)=>{t&&e.updateFocus(e=>{let{graphic:t}=e;return this.recreateGraphics([t])},t)})}destroy(){this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=(0,n.DC)(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=pe.nu,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=(0,n.xt)(this._deconflictor),this._labeler=(0,n.xt)(this._labeler),this._elevationAlignment=(0,n.pR)(this._elevationAlignment),this._scaleVisibility=(0,n.pR)(this._scaleVisibility),this._filterVisibility=(0,n.pR)(this._filterVisibility),this._objectStates=(0,n.pR)(this._objectStates),this.clear(),this._featureStore=(0,n.pR)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,n.xt)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,n.pR)(this._graphicStateTracking),this.stage&&(this.stageLayer=(0,n.pR)(this.stageLayer),this.stage=null),this._set("owner",null);for(const e in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new s.A("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,n.xt)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,n.pR)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,n.pR)(this._spatialIndex)}clear(){var e,t,i,r;null!==(e=this._objectStates)&&void 0!==e&&e.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(e=>e.destroy()),null!==(t=this._spatialIndex)&&void 0!==t&&t.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(n.pR),this._symbols.clear(),this._symbolMaterials=null,this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed"),null===(i=(r=this.owner).notifyContentGeometryUpdate)||void 0===i||i.call(r)}_initializeStage(e,t){this.stage=e.stage,this.stageLayer=new si.x(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);const i=this.stageLayer.events;i.on("transformationChanged",e=>this.notifyGraphicGeometryChanged(e.graphicUid)),i.on("shaderTransformationChanged",e=>this.notifyGraphicGeometryChanged(e.graphicUid)),i.on("visibilityChanged",e=>this.notifyGraphicVisibilityChanged(e.graphicUid)),i.on("geometryAdded",e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),i.on("geometryRemoved",e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),i.on("attributesChanged",e=>(0,ze.b)(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid))}notifyGraphicGeometryChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*mi,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){var e,t;const i=this._visible&&(null==this.layer.opacity||this.layer.opacity>=nt.Q);this.stageLayer.visible!==i&&(this.stageLayer.visible=i,i?this.updateGraphicsVisibilities():this._hideAllGraphics(),null===(e=(t=this.owner).notifyContentGeometryUpdate)||void 0===e||e.call(t))}getGraphics3DGraphicById(e){return null!=e?this.graphics3DGraphics.get(e):void 0}getGraphics3DGraphicByObjectId(e){var t;return null!==(t=this.owner.layer)&&void 0!==t&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null===(t=this.owner.layer)||void 0===t?void 0:t.objectIdField;return(0,Q.RW)(e,i)}get graphics3DGraphicsByObjectID(){var e;const t=null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField;if(!t)return;const i=new Map;return this.graphics3DGraphics.forEach(e=>{if(!e)return;const r=e.graphic,s=this._getGraphicObjectID(r,t);null!=s&&i.set(s,e)}),i}get labelsEnabled(){var e;return!(null===(e=this._labeler)||void 0===e||!e.layerLabelsEnabled())}async updateLabelingInfo(e){var t,i;const r=null===(t=this._deconflictor)||void 0===t?void 0:t.labelingInfoChange(e),s=null===(i=this._labeler)||void 0===i?void 0:i.labelingInfoChange(e);await Promise.allSettled([r,s])}updateVisibilityInfo(){var e,t;null!==(e=this._deconflictor)&&void 0!==e&&e.labelingInfoChange(),null===(t=this._labeler)||void 0===t||t.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let e=!1,t=!1;for(const[i,r]of this._symbols)if(null!=r)switch(r.getFastUpdateStatus()){case Rt.G.Loading:return"unknown";case Rt.G.Fast:this._graphicsBySymbol.has(i)&&(t=!0);break;case Rt.G.Slow:this._graphicsBySymbol.has(i)&&(e=!0);break;case Rt.G.Mixed:this._graphicsBySymbol.has(i)&&(t=e=!0);case Rt.G.Undefined:}return t?e?"mixed":"fast":e?"slow":"mixed"}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return ci.G}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);null!=i&&this._updateUserVisibility(i)}_findGraphics3DGraphicByObjectId(e){return(0,T.$n)(this.graphics3DGraphics,t=>this._getGraphicObjectID(t.graphic)===e)}_updateUserVisibility(e){if(null==e)return!1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&this.stageLayer.visible&&(null==i||!this._objectIdInvisibleSet.has(i));return e.setVisibilityFlag(ue.GRAPHIC,ce.USER,r)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this._whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=(0,u.Tw)();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){const i=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,n=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=t&&!!t.useViewElevation,minDemResolution:null!=t?t.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,a=await e.getProjectedBoundingBox((e,t,s)=>(0,N.projectBuffer)(e,r,t,e,i,t,s),(e,t,r)=>(0,N.projectBuffer)(e,s,t,e,i,t,r),n,null===t||void 0===t?void 0:t.signal);if(!a)return null;const o=a.boundingBox;if(a.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){var l;(0,q.gX)(o,ui);const t=null!==(l=e.getElevation(ui[0],ui[1],0,i,"ground"))&&void 0!==l?l:0;o[2]=Math.min(o[2],t),o[5]=Math.max(o[5],t)}}return{boundingBox:o,screenSpaceObjects:a.screenSpaceObjects}}async whenGraphicBounds(e,t){var i;await(0,a.C_)(()=>{var e;return null===(e=this.owner)||void 0===e?void 0:e.loadedGraphics});const r=null===(i=this.owner.layer)||void 0===i?void 0:i.objectIdField,n=this.owner.loadedGraphics.find(t=>t===e||null!=r&&null!=t.attributes&&e.attributes&&t.attributes[r]===e.attributes[r]);if(!n)throw new s.A("internal:graphic-not-part-of-view","Graphic is not part of this view");const o=await this._whenGraphics3DGraphic(n);return this._boundsForGraphics3DGraphic(o,t)}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,z.i)(bi,0,0,0);let s=0;if(r.render.num>0){if(!(0,k.F)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,_i,t))return null;(0,z.f)(bi,bi,_i),s++}if(r.draped.num>0){var n;const[e,i]=r.draped.origin,a=null!==(n=this._viewElevationProvider.getElevation(e,i,"ground"))&&void 0!==n?n:0;if((0,z.i)(_i,e,i,a),!(0,k.F)(_i,this._viewElevationProvider.spatialReference,_i,t))return null;(0,z.f)(bi,bi,_i),s++}return s>1&&(0,z.g)(bi,bi,1/s),new B.A({x:bi[0],y:bi[1],z:bi[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this._symbols.get(e.id);if(null==i)throw new s.A("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(t);if(-1===r)throw new s.A("internal:missing-symbol-layer","Symbol layer is not in symbol");const n=i.getSymbolLayerSize(r);if(null==n)throw new s.A("internal:missing-size","Symbol layer has no valid size");return n}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(null!=i||null!=this._graphicsWithoutSymbol.get(t)){var r,s;switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":case"popupTemplate":break;case"origin-transform":this._graphicUpdateTransformHandler(i,e)}null===(r=(s=this.owner).notifyContentGeometryUpdate)||void 0===r||r.call(s)}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,()=>{var i,r,s;return!(null==t.newValue||null==e||!e.graphics3DSymbol.updateGeometry(e,t.newValue)||null!==(i=null===(r=this._labeler)||void 0===r?void 0:r.updateGraphicGeometry(e))&&void 0!==i&&!i)&&(null!==(s=this._labeler)&&void 0!==s&&s.setDirty(),!0)});const i=t.graphic.geometry;null!=i&&this._expandComputedExtent(i)}_graphicUpdateTransformHandler(e,t){const i=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t,()=>null!=t.newValue&&null!=e&&null!=i&&e.graphics3DSymbol.updateTransform(e,i.spatialReference,t.newValue,t.action))}_graphicUpdateGeometryOrTransformHandler(e,t,i){if(null!=t.graphic.geometry)if(null!=e)i()||this._recreateGraphic(e.graphic);else{var r;const e=null===(r=t.graphic.symbol)||void 0===r?void 0:r.id;if(e){const t=this._symbols.get(e);if(null!=t&&t.loadStatus===Dt.P.LOADING)return}this._recreateGraphic(t.graphic)}else this._recreateGraphic(t.graphic)}_graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=null!=e?e.graphics3DSymbol:null!=t.oldValue?this._symbols.get(t.oldValue.id):null;if(null==r||null==t.newValue)return void this._recreateGraphic(i);const s=r.symbol,n=this._getConvertedSymbol(t.newValue);if(null!=n&&(n.type!==s.type||"web-style"===n.type)||"web-style"===s.type)return void this._recreateGraphic(i);const a=this._graphicsBySymbol.get(s.id);if(a&&1!==a.size)return void this._recreateGraphic(i);const o=(0,P.Ui)(s,n);if(null==o)return void this._updateSymbolMapping(s.id,n);const l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!(0,P.Im)(l.diff))return void this._recreateGraphic(i);const h=this._getRenderingInfo(i,!1);if(null==h)return void this._recreateGraphic(i);const d=r.extentPadding;for(const c of l.symbolStatePatches)c();if(d!==r.extentPadding&&this._recomputeExtentPadding(),null!=e)for(const c of l.graphics3DGraphicPatches)c(e,h);this._updateSymbolMapping(s.id,n)}_graphicUpdateVisibleHandler(e){var t,i;this._updateUserVisibility(e)&&(null!==(t=this._labeler)&&void 0!==t&&t.setDirty(),null===(i=this._deconflictor)||void 0===i||i.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===ri.q.SYNC&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),t}_endGraphicUpdate(e,t){var i;e&&(t&&null!==(i=this._graphicStateTracking)&&void 0!==i&&i.updateGraphicError(e,t),this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let e=0;this._symbols.forEach(t=>{null!=t&&(e=Math.max(e,t.extentPadding))}),this._set("extentPadding",e)}_expandComputedExtent(e){const t=pi,i=e.spatialReference;(0,Q.w9)(e,t);const r=this._viewSpatialReference,s=di.tmpVec;if((0,Y.aI)(i,r)||(0,Z.L)(t[0],t[1],0,i,s,r)&&(t[0]=s[0],t[1]=s[1],(0,Z.L)(t[3],t[4],0,i,s,r),t[3]=s[0],t[4]=s[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const n=this.computedExtent;let a=null;const o=isFinite(t[2])&&isFinite(t[5]),l=o&&(null==(null===n||void 0===n?void 0:n.zmin)||t[2]<n.zmin),h=o&&(null==(null===n||void 0===n?void 0:n.zmax)||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||l||h)&&(a=this._propertiesPool.get("computedExtent"),a.xmin=Math.min(t[0],n.xmin),a.ymin=Math.min(t[1],n.ymin),a.xmax=Math.max(t[3],n.xmax),a.ymax=Math.max(t[4],n.ymax),a.spatialReference=r):(a=this._propertiesPool.get("computedExtent"),a.xmin=t[0],a.ymin=t[1],a.xmax=t[3],a.ymax=t[4],a.spatialReference=r),a&&(l&&(a.zmin=t[2]),h&&(a.zmax=t[5]),this._set("computedExtent",a))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){var e,t;this._abortElevationInfoChange();const i=new AbortController;this._elevationInfoChangeAbortController=i;const r=(0,C.MF)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await(0,C.q6)(r,this._viewSpatialReference,i.signal,h.A.getLogger(this)),(0,u.Te)(i.signal),this._elevationInfoChangeAbortController=null,null!==(e=this._labeler)&&void 0!==e&&e.elevationInfoChange(),this.forEachGraphics3DSymbol((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?null===t||void 0===t||t.forEach(e=>{const t=e.graphic,i=e.labelLayers;for(const r of i)r.graphics3DSymbolLayer.updateGraphicElevationContext(t,r)}):this._recreateSymbol(i)}),this.updateStageLayerElevationProvider(),null===(t=this._elevationAlignment)||void 0===t||t.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,n.WD)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new Qt({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){var e,t,i,r;this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),null!==(e=this._labeler)&&void 0!==e&&e.reset(),null!==(t=this._deconflictor)&&void 0!==t&&t.clear(),null!==(i=this._elevationAlignment)&&void 0!==i&&i.clear(),null!==(r=this.stageLayer)&&void 0!==r&&r.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,n.WD)(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this._startCreateGraphics)return;const{loadedGraphics:i,view:r}=this.owner,s=null!==(e=r.basemapTerrain)&&void 0!==e&&e.tilingScheme&&null!==i&&void 0!==i&&i.length?i.toArray():null;!t&&s||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),s&&(t?this.add(s):this.recreateGraphics(s))}_recreateSymbol(e){const t=this._graphicsBySymbol.get(e),i=[];t&&(t.forEach((e,t)=>{var r,s,n;const a=e.usedMemory;this._conditionalRemove(e,t),null!==(r=this._spatialIndex)&&void 0!==r&&r.remove(e),i.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,a),this._updateLayerVisibility(),this._featureStore.events.emit("changed"),null===(s=(n=this.owner).notifyContentGeometryUpdate)||void 0===s||s.call(n)}),this._graphicsBySymbol.set(e,new Map));const r=this._symbols.get(e);(0,n.pR)(r),this._symbols.delete(e),this._symbolMaterials=null,(0,n.pR)(this._unusedSymbolsCache.pop(e)),this.add(i)}_recreateGraphicsForSymbol(e){const t=this._graphicsBySymbol.get(e);if(t){const e=[];t.forEach(t=>e.push(t.graphic)),this.recreateGraphics(e)}}_conditionalRemove(e,t){var i,r,s;this._graphicsDrapedUids.delete(t),null!==(i=this._objectStates)&&void 0!==i&&i.removeGraphic(e),null!==(r=this._labeler)&&void 0!==r&&r.removeGraphic(e),null!==(s=this._deconflictor)&&void 0!==s&&s.removeGraphic(e),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(e)}add(e){var t;e&&0!==e.length&&(null!==(t=this.owner.view.basemapTerrain)&&void 0!==t&&t.tilingScheme?(this._updatePolicyForGraphics(e)===ri.q.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("dataUpdating")):h.A.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===ri.q.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(null!=t.geometry&&"mesh"===t.geometry.type&&!t.geometry.loaded)return ri.q.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){var t,i;this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const r of e)this._addGraphic(r,this._getRenderingInfo(r),ri.q.SYNC);this._cleanupSymbols(),null!==(t=this._labeler)&&void 0!==t&&t.setDirty(),null===(i=this._deconflictor)||void 0===i||i.setDirty()}_addDelayed(e){for(const i of e){var t;const e=i.uid;let r=this._pendingUpdates.get(e);r?r.add?r.state!==gi.NEW&&(null===(t=r.abortController)||void 0===t||t.abort()):this._pendingAdds++:(r=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(e,r)),r.add=i}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(e){this.effectiveUpdatePolicy===ri.q.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("dataUpdating")}_removeImmediate(e){var t,i;for(const r of e)this._removeGraphic(r);this._cleanupSymbols(),null!==(t=this._labeler)&&void 0!==t&&t.setDirty(),null===(i=this._deconflictor)||void 0===i||i.setDirty()}_removeDelayed(e){for(const i of e){var t;const e=i.uid,r=this._pendingUpdates.get(e);if(r)r.add&&(r.remove?r.add=null:this._pendingUpdates.delete(e),r.state===gi.LOADING&&null!==(t=r.abortController)&&void 0!==t&&t.abort(),this._pendingAdds--);else{const t=this._pendingUpdatesPool.pushNew();t.remove=i,this._pendingUpdates.set(e,t),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&h.A.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(e){var t;if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&null!==(t=this._spatialIndex)&&void 0!==t&&t.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[t,i]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(i.remove&&!i.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,this._pendingUpdates.delete(t),0===this._pendingRemoves))break}}for(const[i,r]of this._pendingUpdates){if(e.done)break;r.add&&r.state===gi.NEW&&this._processPendingUpdateNew(r);let t=this.effectiveUpdatePolicy;if(!r.remove||r.add&&r.state!==gi.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(r.remove),r.remove=null,t=ri.q.SYNC),r.add)switch(r.state){case gi.READY:this._addGraphic(r.add,r.renderingInfo,t),r.add=null,this._pendingAdds--,e.madeProgress();break;case gi.REJECTED:r.add=null,this._pendingAdds--;case gi.LOADING:}null==r.remove&&null==r.add&&this._pendingUpdates.delete(i)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=gi.READY);const t=e.add.geometry;null==t||"mesh"!==t.type||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=gi.LOADING,e.abortController=new AbortController;const i=e.abortController.signal;try{await t.load({signal:i})}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,(0,u.zf)(t)?e.state=gi.NEW:e.state=gi.REJECTED}async _processPendingUpdateNewRenderingInfo(e){var t;if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add),void(e.state=gi.READY);e.state=gi.LOADING,e.abortController=new AbortController;let i=null;try{i=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(r){return e.abortController=null,void((0,u.zf)(r)?e.state=gi.NEW:e.state=gi.REJECTED)}null==(null===(t=i)||void 0===t?void 0:t.symbol)?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),e.renderingInfo=null):e.renderingInfo=i,e.state=gi.READY}_addGraphic(e,t,i){if(this._graphicsWithoutSymbol.set(e.uid,e),null==(null===t||void 0===t?void 0:t.symbol)||!(0,Q.N3)(e))return;const r=this.stage.renderView.olidRenderHelper;if(r&&this.setUidToIdOnAdd){var s;const t=(0,re.sG)(this.owner.view,this.owner.layerViewUid);r.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.owner.layerViewUid,!!this.layer.popupEnabled&&!t&&(0,ni.d0)(this.layer,null===(s=this.owner.view.popup)||void 0===s?void 0:s.defaultPopupTemplateEnabled))}const n=t.symbol,a=this.getOrCreateGraphics3DSymbol(n,t.renderer);if(null==a)return;this._expandComputedExtent(e.geometry);const o=this._beginGraphicUpdate(e),l=new Ce(e,t,this.layer);let h=!1;const d=e=>{e===a.symbol.id&&(h=!0)};this._whenSymbolRemoved.push(d);const c=()=>{var t,i,r;if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(d),this._graphicsWaitingForSymbol.get(e.uid)!==o||h||a.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,this._cleanupSymbols();else{const t=this._createGraphics3DGraphic(a,l);this._spatialIndex&&null!=t&&this._spatialIndex.add(t),--a.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit("changed"),null!==(t=(i=this.owner).notifyContentGeometryUpdate)&&void 0!==t&&t.call(i),null===(r=this._labeler)||void 0===r||r.setDirty()}},p=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(d),h||((0,u.zf)(t)?this.add([e]):a.destroyed||this._endGraphicUpdate(e,t)))};++this._loadingSymbols,i===ri.q.ASYNC?a.load(()=>this._dataUpdateQueue.push(c,null).catch(u.QZ),e=>this._dataUpdateQueue.push(()=>p(e),null).catch(u.QZ)):a.load(c,p)}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r,s,n,a;i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,o=i.isElevationSource;this._conditionalRemove(i,t),null===(r=this._spatialIndex)||void 0===r||r.remove(i);const l=i.graphics3DSymbol.symbol.id;null!==(s=this._graphicsBySymbol.get(l))&&void 0!==s&&s.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,o),i.destroy(),this._featureStore.events.emit("changed"),null===(n=(a=this.owner).notifyContentGeometryUpdate)||void 0===n||n.call(a)}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(e){if(e instanceof ne.A||e instanceof ae.A){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(t=>t.symbol===e)}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof ne.A&&!this._hasLabelingContext(e))||(h.A.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(e){var t;let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=e.geometry;if(null==r)return i&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,H.canProjectWithoutEngine)(r.spatialReference,this._viewSpatialReference))return i&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return i&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;const s=this.rendererHasGeometryOperations?(0,O.wP)(e,this.layer):e;let n;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer))n=this.owner.getRenderingInfo(s,this.currentRenderer,this._arcadeOnDemand);else{const e=s.symbol||(0,le.dX)(s.geometry);n=new ie.$(null,e)}return null==(null===(t=n)||void 0===t?void 0:t.symbol)?(i&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):n}_getRenderingInfoAsync(e,t){if(null==e.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,h.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;const i=this.rendererHasGeometryOperations?(0,O.wP)(e,this.layer):e;return this.owner.getRenderingInfoAsync(i,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const i=this._getConvertedSymbol(e);if(!i)return null;let r;if(null!=t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=(0,J.t)(t.backgroundFillSymbol,{ignoreDrivers:!0});null!=e.symbol&&(r=e.symbol.symbolLayers)}const s=function(e,t,i){return"point-3d"===e.type?new Ut(e,t,i):new Tt(e,t,i)}(i,this.symbolCreationContext,r);return s.load(()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")},()=>{}),s}getOrCreateGraphics3DSymbol(e,t){let i=this._symbols.get(e.id);if(void 0===i){const r=this._unusedSymbolsCache.pop(e.id);i=null!=r?r:e instanceof oe.A?new Vt(e,e=>this._dataUpdateQueue.push(e,null),e=>this._createGraphics3DSymbol(e,t)):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,i),this._symbolMaterials=null}return null!=i&&++i.referenced,i}trackGraphicState(e){return null==this._graphicStateTracking&&(this._graphicStateTracking=new jt(this)),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,i&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){var i,r,s;const n=t.graphic;if(this._graphicsWithoutSymbol.delete(n.uid),!this._symbols.has(e.symbol.id))return this.add([n]),null;if(this.graphics3DGraphics.has(n.uid))return null;const a=e.createGraphics3DGraphic(t);if(null==a)return null;this._addGraphics3DGraphic(a);const o=e.symbol.id;if(this._graphicsBySymbol.has(o)||this._graphicsBySymbol.set(o,new Map),this._graphicsBySymbol.get(o).set(n.uid,a),a.isDraped&&this._graphicsDrapedUids.add(n.uid),a.centroid=null,null!=n.geometry&&"point"!==n.geometry.type&&(a.centroid=(0,Fe.W$)(n.geometry,this._viewSpatialReference)),this._updateUserVisibility(a),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(a),null!=this._filterVisibility){const{defaultVisibility:e}=this._filterVisibility;a.setVisibilityFlag(ue.GRAPHIC,ce.FILTER,e),e||this._filterVisibility.reapply()}null!==(i=this._deconflictor)&&void 0!==i&&i.addGraphic(a),null!==(r=this._labeler)&&void 0!==r&&r.addGraphic(a),null!==(s=this._objectStates)&&void 0!==s&&s.addGraphic(a),a.initialize(this.stageLayer),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(a);const l=this._whenGraphics3DGraphicRequests[n.uid];return l&&(delete this._whenGraphics3DGraphicRequests[n.uid],l.resolve(a)),this._symbolMaterials=null,a}async rendererChange(e){if(this._rendererChangeAbortController=(0,n.DC)(this._rendererChangeAbortController),e!==this.currentRenderer)if(this._validateRenderer(e),null==e&&this._currentRendererChange(null,!1),K(e))if(null!==e&&void 0!==e&&e.arcadeRequired){const t=new AbortController;this._rendererChangeAbortController=t;const{arcadeUtils:i}=await this._ensureArcade();(0,u.Te)(t);const r=i.hasGeometryOperations(e);r&&(await i.enableGeometryOperations(),(0,u.Te)(t)),this.effectiveUpdatePolicy===ri.q.ASYNC?await this._updateQueue.push(()=>this._currentRendererChange(e,r),t.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===ri.q.ASYNC){const t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push(()=>this._currentRendererChange(e,!1),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await(0,se.l)(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(e,t){var i;this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;const r=this.symbolCreationContext.renderer;if(e===r)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==e)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const s=(0,P.Ui)(r,e);this._updateUnchangedSymbolMappings(s,e,r),this.symbolCreationContext.renderer=e,null!=s&&("complete"===s.type?this.recreateAllGraphicsAndSymbols():"partial"===s.type&&(this._applyRendererDiff(s,e,r)?null===(i=this._labeler)||void 0===i||i.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,i){var r,s;e=e||[],t=t||[];const n=[];for(const a of t){const t=this._graphicsBySymbol.get(a.id);t&&t.forEach((r,s)=>{const o=r.graphic,l=this.layer instanceof A.A?this.layer:null,h=this._arcadeOnDemand;if(a===i.defaultSymbol&&i.getSymbol((0,O.wP)(o,l),{arcade:h})===i.defaultSymbol)return;const d=r.usedMemory;e.length||i.defaultSymbol?n.push(o):this._graphicsWithoutSymbol.set(s,o);const c=this.graphics3DGraphics.get(s);this._conditionalRemove(c,s),r.destroy(),t.delete(s),this._removeGraphics3DGraphic(s,d),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(e=>e(a.id))}(e.length||n.length)&&(this._graphicsWithoutSymbol.forEach(e=>n.push(e)),this._graphicsWithoutSymbol.clear(),this.add(n)),this._cleanupSymbols(),null!==(r=this._labeler)&&void 0!==r&&r.setDirty(),null===(s=this._deconflictor)||void 0===s||s.setDirty()}_applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,s=e.diff.uniqueValueInfos;if(r||s){const n=null===s||void 0===s?void 0:s.changed,a=null===s||void 0===s?void 0:s.unchanged;if(n&&a&&n.some(e=>a.some(t=>{var i,r;return(null===(i=t.oldValue.symbol)||void 0===i?void 0:i.id)===(null===(r=e.oldValue.symbol)||void 0===r?void 0:r.id)})))return!1;const o=s?s.added.map(e=>e.symbol).filter(F.Ru):[],l=s?s.removed.map(e=>e.symbol).filter(F.Ru):[];if(n)for(let e=0;e<n.length;e++)o.push(n[e].newValue.symbol),l.push(n[e].oldValue.symbol);return r?(i.defaultSymbol&&l.push(i.defaultSymbol),t.defaultSymbol&&o.push(t.defaultSymbol)):i.defaultSymbol&&o.length&&l.push(t.defaultSymbol),this._applySymbolSetDiff(o,l,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,i){if("unique-value"!==(null===t||void 0===t?void 0:t.type)||"unique-value"!==(null===i||void 0===i?void 0:i.type)||null!=e&&"partial"!==e.type)return[];const r=e=>null!=e?e.id:null,s=e&&e.diff,n=null===s||void 0===s?void 0:s.defaultSymbol,a=s&&s.uniqueValueInfos;let o;if(a)o=a.unchanged.map(e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}));else{o=[];for(const e of null!==(l=i.uniqueValueInfos)&&void 0!==l?l:[]){var l,h;const i=r(e.symbol),s=null===(h=t.uniqueValueInfos)||void 0===h?void 0:h.find(t=>t.value===e.value);s&&i!==r(s.symbol)&&o.push({oldId:i,newId:r(s.symbol)})}}return!n&&i.defaultSymbol&&o.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),o}_updateSymbolMapping(e,t){const i=null!=t&&t?"string"==typeof t?t:t.id:null;if(null==e||e===i)return;const r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(i,r);const s=this._symbols.get(e);if(void 0!==s&&(this._symbols.delete(e),this._symbols.set(i,s),this._symbolMaterials=null,null!=s)){const e="string"==typeof t?null:t;null!=e?s.symbol=e:s.symbol.id=i}}_updateUnchangedSymbolMappings(e,t,i){const r=this._calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:s,newId:n}of r)this._updateSymbolMapping(s,n)}_applyRendererDiff(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof X.A&&i instanceof X.A&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(const r of this._graphicsBySymbol.keys()){const i=this._symbols.get(r);if(null!=i)switch(i.applyRendererDiff(e,t)){case Rt.w.RecreateSymbol:this._recreateSymbol(r);break;case Rt.w.RecreateGraphics:this._recreateGraphicsForSymbol(r);case Rt.w.FastUpdate:}}return!0}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged("opacity",t))}_slicePlaneEnabledChange(e){var t,i;e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t)),null!==(t=this._deconflictor)&&void 0!==t&&t.slicePlaneEnabledChange(),null===(i=this._labeler)||void 0===i||i.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)})}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((e,t,i)=>{e.globalPropertyChanged("skipHighSymbolLods",t)||this._recreateSymbol(i)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,V._)(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=(0,W.vt)();return function(e,t,i){if(null==e||null==i)return!1;let r=!0;return ti[0]=null!=e.xmin?e.xmin:0,ti[1]=null!=e.ymin?e.ymin:0,ti[2]=null!=e.zmin?e.zmin:0,r=r&&(0,N.projectBuffer)(ti,e.spatialReference,0,ti,i,0),t[0]=ti[0],t[1]=ti[1],ti[0]=null!=e.xmax?e.xmax:0,ti[1]=null!=e.ymax?e.ymax:0,ti[2]=null!=e.zmax?e.zmax:0,r=r&&(0,N.projectBuffer)(ti,e.spatialReference,0,ti,i,0),t[2]=ti[0],t[3]=ti[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}(e,r,t)?this.symbolCreationContext.clippingExtent=(0,q.Jt)((0,q.vt)(),r):this.symbolCreationContext.clippingExtent=null,!(0,q.aI)(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){var t,i;if(this.destroyed)return;let r=!1;this.graphics3DGraphics.forEach(t=>{e(t)&&(r=!0)}),r&&(null!==(t=this._labeler)&&void 0!==t&&t.setDirty(),null===(i=this._deconflictor)||void 0===i||i.setDirty())}forEachGraphics3DSymbol(e,t){for(const[i,r]of this._symbols){if(null==r)return;e(r,this._graphicsBySymbol.get(i)||fi,i)}if(null===t||void 0===t||!t.excludeUnused)for(const i of this._unusedSymbolsCache)e(i,void 0,i.symbol.id)}updateGraphicsVisibilities(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(e=>{var t;const i=this._updateUserVisibility(e),r=!(null===(t=this._scaleVisibility)||void 0===t||!t.updateVisibility(e));return i||r})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(ue.GRAPHIC,ce.USER,!1))}_validateRenderer(e){var t;const i=()=>"'".concat(this.layer.title?"".concat(this.layer.title,", "):"","id:").concat(this.layer.id,"'"),r=ee(e,{geometryType:null===(t=this.layer)||void 0===t?void 0:t.geometryType,logWarning:(e,t)=>h.A.getLogger(this).warn(e,"Symbology conversion for layer ".concat(i(),": ").concat(t))});if(r){const e="Renderer for layer ".concat(i," is not supported in a SceneView");h.A.getLogger(this).warn(e,r.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach((t,i)=>{if(null==t||t.referenced>0)return;const r=this._graphicsBySymbol.get(i);r&&0!==r.size||(this._graphicsBySymbol.delete(i),this._symbols.delete(i),this._symbolMaterials=null,this._unusedSymbolsCache.put(i,t,M.Ti),e=!0)}),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){}get performanceInfo(){return new zt(this.graphics3DGraphics.size,Array.from(this.graphics3DGraphics.values()).reduce((e,t)=>e+(t.isVisible()?1:0),0),this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}},di=hi,hi.tmpVec=(0,g.vt)(),hi);var gi;(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"computedExtent",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"currentRenderer",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"rendererHasGeometryOperations",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_frameTaskHandle",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_dataUpdateQueue",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_updateQueue",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"_viewSpatialReference",null),(0,r._)([(0,o.MZ)()],yi.prototype,"_rendererChangeAbortController",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_elevationInfoChangeAbortController",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_initializeAbortController",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_elevationAlignment",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_scaleVisibility",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_filterVisibility",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_initializePromise",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_spatialIndex",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"extentPadding",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_featureStore",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_objectStates",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_loadingSymbols",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"compressionTracker",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"preferredUpdatePolicy",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_forcedUpdatePolicy",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"effectiveUpdatePolicy",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"elevationFeatureExpressionEnabled",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"owner",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"layer",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"graphicSymbolSupported",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"componentFactories",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"setUidToIdOnAdd",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"featureStore",null),(0,r._)([(0,o.MZ)()],yi.prototype,"initializePromise",null),(0,r._)([(0,o.MZ)()],yi.prototype,"scaleVisibility",null),(0,r._)([(0,o.MZ)()],yi.prototype,"elevationAlignment",null),(0,r._)([(0,o.MZ)()],yi.prototype,"objectStates",null),(0,r._)([(0,o.MZ)()],yi.prototype,"filterVisibility",null),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"updating",null),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"dataUpdating",null),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"running",null),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"suspendedOrOutsideOfView",null),(0,r._)([(0,o.MZ)({readOnly:!0,dependsOn:[]})],yi.prototype,"updatingRemaining",null),(0,r._)([(0,o.MZ)({readOnly:!0})],yi.prototype,"displayFeatureLimit",null),(0,r._)([(0,o.MZ)({readOnly:!0,dependsOn:[]})],yi.prototype,"averageSymbolComplexity",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"hasZ",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],yi.prototype,"hasM",void 0),(0,r._)([(0,o.MZ)()],yi.prototype,"_objectIdField",null),yi=di=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.Graphics3DCore")],yi),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(gi||(gi={}));class vi{constructor(){this.add=null,this.renderingInfo=null,this.state=gi.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=gi.NEW,this.abortController=null,this.remove=null}}const mi=10,bi=(0,g.vt)(),_i=(0,g.vt)(),fi=new Map;class Si{constructor(){this._extents=new U.A({allocator:e=>e||(0,W.vt)()}),this._tmpExtent=(0,W.vt)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),(0,W.C)(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:pe.Bb;const t=this._extents,i=new Set;let r=0;for(;r!==t.length;){t.sort((e,t)=>e[0]-t[0]),r=t.length,i.clear();for(let r=0;r<t.length;++r){if(e.done)return;const s=t.at(r);if(s){for(let e=r+1;e<t.length;++e){const r=t.at(e);if(null==r||r[0]>=s[2])break;i.add(r)}i.forEach(r=>{if(s===r)return;if(r[2]<=s[0])return void i.delete(r);const n=(0,W.Wc)(s),a=(0,W.Wc)(r),o=this._tmpExtent;(0,W.fT)(s,r,o);const l=n+a;((0,W.Wc)(o)-l)/l<.05&&((0,W.C)(s,o),i.delete(r),t.remove(r),e.madeProgress())}),i.add(s)}}}this._dirty=!1}_contains(e){return this._extents.some(t=>(0,W.gR)(t,e))}_removeContained(e){this._extents.filterInPlace(t=>!(0,W.gR)(e,t))}get test(){}}let Ci=class extends E.A{constructor(e){super(e),this._dirtyExtents=new Si,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new ge.A}initialize(){var e;const t=this.elevationProvider,i=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=i.registerTask(wi(null===(e=this.graphicsCore.layer.elevationInfo)||void 0===e?void 0:e.mode),this),this.addHandles([t.on("elevation-change",e=>this._elevationChanged(e)),(0,a.wB)(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,(0,a.wB)(()=>{var e;return wi(null===(e=this.graphicsCore.layer.elevationInfo)||void 0===e?void 0:e.mode)},e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run(()=>this._dirtyExtents.merge(e));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===ri.q.ASYNC;for(const s of this._dirtyGraphicsSet.keys()){var r;const n=this.graphicsCore.getGraphics3DGraphicById(s);if(this._dirtyGraphicsSet.delete(s),null!=n&&(n.alignWithElevation(this.elevationProvider,t,i),null!==(r=this.graphicsCore.deconflictor)&&void 0!==r&&r.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);null!=t&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}};function wi(e){return null==e?pe.W6.ELEVATION_ALIGNMENT:"relative-to-scene"===e?pe.W6.ELEVATION_ALIGNMENT_SCENE:pe.W6.ELEVATION_ALIGNMENT}(0,r._)([(0,o.MZ)()],Ci.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,o.MZ)()],Ci.prototype,"graphicsCore",void 0),(0,r._)([(0,o.MZ)()],Ci.prototype,"queryGraphicUIDsInExtent",void 0),(0,r._)([(0,o.MZ)()],Ci.prototype,"elevationProvider",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],Ci.prototype,"updating",null),(0,r._)([(0,o.MZ)({readOnly:!0})],Ci.prototype,"updatingRemaining",null),Ci=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],Ci);var xi=i(34111),Ei=i(4212),Pi=i(15941),Gi=i(34761),Ai=i(13191),Oi=i(5809),Li=i(4763),Ii=i(44230),Ri=i(13927),Di=i(95925);function Fi(e,t,i,r){return Vi(e,t,i,Mi(r,t,i,!0))}const Ti={dir:(0,g.vt)(),len:0,clip:(0,xt.vt)()};function Mi(e,t,i,r){const s=Ti;return e?(i&&r&&(s.len=(0,z.j)(t,i)),(0,z.c)(s.dir,e)):r?(s.len=(0,z.j)(t,i),(0,z.d)(s.dir,i,t),(0,z.g)(s.dir,s.dir,1/s.len)):((0,z.d)(s.dir,i,t),(0,z.n)(s.dir,s.dir)),s}function Ui(e,t,i){const r=(0,z.e)((0,Ri.Qj)(e),i.dir),s=-(0,Ri.mN)(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function Vi(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let s=0;s<e.length;s++)if(!Ui(e[s],t,r))return!1;return!0}const zi=.5*Math.PI,ji=zi/Math.PI*180;class Bi{constructor(e){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,g.vt)(),direction:(0,g.vt)()},this._renderCoordsHelper=e.renderCoordsHelper;for(let t=0;t<4;t++)this._extent[t]={origin:(0,g.vt)(),direction:(0,g.vt)(),cap:{next:null,direction:(0,g.vt)()}},this._planes[t]=(0,Ri.vt)();this._planes[Li.FB.NEAR]=(0,Ri.vt)(),this._planes[Li.FB.FAR]=(0,Ri.vt)(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const s=this._extent;this._toRenderBoundingExtent(e,t,i),(0,z.f)(this._center.origin,s[0].origin,s[2].origin),(0,z.g)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||(0,z.g)(this._center.direction,this._center.direction,-1);for(let n=0;n<4;n++){const e=s[n];this._renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=s[3===n?0:n+1];e.cap.next=t.origin,(0,z.E)(e.cap.direction,e.origin,t.origin),(0,Ri.mR)(e.direction,e.cap.direction,e.origin,this._planes[n]),r||(0,z.g)(e.direction,e.direction,-1)}(0,Ri.mR)(s[0].cap.direction,s[1].cap.direction,s[0].origin,this._planes[Li.FB.NEAR]),r?(0,Ri.ze)(this._planes[Li.FB.NEAR],this._planes[Li.FB.FAR]):((0,Ri.C)(this._planes[Li.FB.FAR],this._planes[Li.FB.NEAR]),(0,Ri.ze)(this._planes[Li.FB.NEAR],this._planes[Li.FB.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*(0,xi.tO)(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===we.RT.Global){const i=this._maxSpanSpatialReference.isGeographic?ji:zi*t;if(this._maxSpan>i)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(i||!e.intersectsRay((0,Di.LV)(t.origin,t.direction)))}for(let s=0;s<this._extent.length;s++){const t=this._extent[s];if(!i&&e.intersectsRay((0,Di.LV)(t.origin,t.direction)))return!0;if(e.intersectsLineSegment((0,Ii.Cr)(t.origin,t.cap.next,Yi),t.cap.direction))return!0}const r=i?this._planes:this._planesWithoutFar;for(let s=0;s<e.lines.length;s++){const t=e.lines[s];if(Fi(r,t.origin,t.endpoint,t.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){(0,W.gX)(e,Ni),Ni[2]=i,(0,Oi.l)(t,Ni,ki,this._renderCoordsHelper.spatialReference),(0,Gi.B8)(Zi,ki),(0,q.Ie)(qi);for(const{x0:r,x1:s,y0:n,y1:a}of Hi)for(let o=0;o<5;o++){const l=o/4;Ni[0]=(0,Pi.Cc)(e[r],e[s],l),Ni[1]=(0,Pi.Cc)(e[n],e[a],l),Ni[2]=i,(0,k.F)(Ni,t,Ni,this._renderCoordsHelper.spatialReference),(0,z.t)(Ni,Ni,Zi),(0,q.iT)(qi,Ni)}(0,z.i)(this._extent[0].origin,qi[0],qi[1],qi[2]),(0,z.i)(this._extent[1].origin,qi[3],qi[1],qi[2]),(0,z.i)(this._extent[2].origin,qi[3],qi[4],qi[2]),(0,z.i)(this._extent[3].origin,qi[0],qi[4],qi[2]);for(let r=0;r<4;++r)(0,z.t)(this._extent[r].origin,this._extent[r].origin,ki)}_toRenderBoundingExtentLocal(e,t,i){Pt(e,t,Wi,this._renderCoordsHelper.spatialReference),(0,z.i)(this._extent[0].origin,Wi[0],Wi[1],i),(0,z.i)(this._extent[1].origin,Wi[2],Wi[1],i),(0,z.i)(this._extent[2].origin,Wi[2],Wi[3],i),(0,z.i)(this._extent[3].origin,Wi[0],Wi[3],i)}_toRenderBoundingExtent(e,t,i){switch(this._renderCoordsHelper.viewingMode){case we.RT.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case we.RT.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:(0,Ei.Xb)(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if((0,Ri.mN)(e.planes[Li.FB.NEAR],this._center.origin)<0&&(0,z.e)(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this._extent[t];if((0,Ri.mN)(e.planes[Li.FB.NEAR],i.origin)<0&&(0,z.e)(i.direction,e.direction)<0)return!0}return!1}}const Hi=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Ni=(0,g.vt)(),ki=(0,Ai.vt)(),Zi=(0,Ai.vt)(),qi=(0,q.vt)(),Wi=(0,W.vt)(),Yi=(0,Ii.vt)();let Qi=class extends E.A{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new Bi({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,r=t.resourceController.scheduler;this.addHandles([t.on("resize",()=>this._viewChange()),(0,a.wB)(()=>t.state.camera,()=>this._viewChange(),a.OH),r.registerTask(pe.W6.FRUSTUM_VISIBILITY,this),(0,a.wB)(()=>i.visibleElevationBounds,()=>this._elevationBoundsChange())]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([(0,a.wB)(()=>{var e;return[i.baseOpacity,i.wireframe,null===(e=t.map)||void 0===e||null===(e=e.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type]},()=>this._updateIsVisibleBelowSurface(),a.Vh)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){var e;const t=this.graphicsCoreOwner.view,i=t.basemapTerrain,r="local"===t.viewingMode,s="none"===(null===(e=t.map.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type);this._isVisibleBelowSurface=r||!i.opaque||s}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*(0,xi.tO)(e.spatialReference).radius;else{const{min:i,max:r}=e.basemapTerrain.visibleElevationBounds;t=i-Math.max(1,(r-i)*(1.2-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get running(){return this.updating}runTask(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),ci.G;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,i=(0,xi.tO)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,i)),e.madeProgress()}};(0,r._)([(0,o.MZ)({readOnly:!0})],Qi.prototype,"suspended",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],Qi.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],Qi.prototype,"updating",void 0),Qi=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],Qi);var $i=i(83490);class Xi{}class Ji extends Xi{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}}class Ki extends Xi{constructor(e,t,i){super(),this.objectStateId=e,this.object=t,this.owner=i}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}}class er extends Xi{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class tr{constructor(){this._items=[]}addObject(e,t){this._items.push(new Ji(t,e))}addRenderGeometry(e,t,i){this._items.push(new Ki(t,e,i))}addExternal(e,t){this._items.push(new er(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){const{_items:t}=this;for(let i=t.length-1;i>=0;--i){const r=t[i];e(r)&&(r.remove(),t.splice(i,1))}}}class ir extends tr{constructor(){super(...arguments),this.stateType=$i.Mg.MaskOccludee}}class rr extends tr{constructor(e){super(),this.highlightName=e,this.stateType=$i.Mg.Highlight}}class sr{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){const t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}}class nr extends sr{constructor(e){super(e),this.stateType=$i.Mg.MaskOccludee,this.objectStateSet=new ir}}class ar extends sr{constructor(e,t){super(t),this.highlightName=e,this.stateType=$i.Mg.Highlight,this.objectStateSet=new rr(e)}}class or{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){const t=new nr(e);this._stateSets.push(t);const i=(0,c.hA)(()=>this.releaseSet(t));return{set:t,handle:i}}acquireHighlightSet(e,t){const i=new ar(e,t);this._stateSets.push(i);const r=(0,c.hA)(()=>this.releaseSet(i));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&i.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(t=>this.setUid(e,t))}setObjectIds(e,t){t.forEach(t=>e.ids.add(t)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(t=>{t&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(i=>{const r=t.get(i);r&&r.addObjectStateSet(e.objectStateSet)})}get test(){}}var lr=i(90992);let hr=class extends E.A{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new G.U,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(pe.W6.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){const t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this._extent=null!==e&&void 0!==e?e:null;else{const r=(0,W.vt)();Pt(e,t,r,i)?this._extent=r:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,t=e.effectiveScaleRange;let i=this.layerScaleEnabled&&null!=t&&dr(t.minScale,t.maxScale);e.labelingInfo&&!i&&(i=e.labelingInfo.some(e=>{var t,i;return e&&dr(null!==(t=e.minScale)&&void 0!==t?t:0,null!==(i=e.maxScale)&&void 0!==i?i:0)}));const r=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.hasHandles(cr)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",e=>this._scaleUpdateHandler(e)),cr),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),cr)):!i&&this.hasHandles(cr)&&this.removeHandles(cr),r}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){const t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return ci.G;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:e,maxScale:i}=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,e,i,e=>this._finishUpdate(e))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}_visibleAtLayerScale(e){const t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,lr.JU)(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return(0,lr.JU)(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return null!=e.centroid?t=e.centroid:null!=e.graphic.geometry&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(!this._scaleRangeActive)return!1;const t=this._graphicVisible(e);return e.setVisibilityFlag(ue.GRAPHIC,ce.SCALE_RANGE,t)}updateGraphicLabelScaleVisibility(e){var t,i;if(!this._scaleRangeActive)return!1;if(!e.labelLayers.length)return!1;const r=this._graphicScale(e),s=this._updateLabelScaleVisibility(e,r);return s&&(null!==(t=this.graphicsCore.deconflictor)&&void 0!==t&&t.setDirty(),null!==(i=this.graphicsCore.labeler)&&void 0!==i&&i.setDirty()),s}_updateLabelScaleVisibility(e,t){if(!e.labelLayers.length)return!1;const i=e.labelLayers[0].labelClass;if(null!=(null===i||void 0===i?void 0:i.minScale)&&null!=i.maxScale){const r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(ue.LABEL,ce.SCALE_RANGE,r))return!0}return!1}_scaleUpdateHandler(e){var t,i;if(this._setDirty(),!this.graphicsCore.visible)return;const r=e.extent,s=e.scale,n=this._visibleAtLayerScale(s);let a=!1;const o=this.graphicsCoreOwner.view.spatialReference,l=e.spatialReference;if(null==l)return void h.A.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const d=!l.equals(o);if(d&&!Pt(r,l,ur,o))return void h.A.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+l+" to wkid "+o);const c=d?ur:r;this.queryGraphicUIDsInExtent(c,o,e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);if(null==t)return;const i=t.centroid;null!=i&&(r[0]>i.x||r[1]>i.y||r[2]<i.x||r[3]<i.y)||(t.setVisibilityFlag(ue.GRAPHIC,ce.SCALE_RANGE,n)&&(a=!0),this._updateLabelScaleVisibility(t,s)&&(a=!0))}),a&&(null!==(t=this.graphicsCore.deconflictor)&&void 0!==t&&t.setDirty(),null===(i=this.graphicsCore.labeler)||void 0===i||i.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(ue.GRAPHIC,ce.SCALE_RANGE,!0)):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}};function dr(e,t){return e>0||t>0}(0,r._)([(0,o.MZ)()],hr.prototype,"graphicsCoreOwner",void 0),(0,r._)([(0,o.MZ)()],hr.prototype,"layer",void 0),(0,r._)([(0,o.MZ)()],hr.prototype,"queryGraphicUIDsInExtent",void 0),(0,r._)([(0,o.MZ)()],hr.prototype,"graphicsCore",void 0),(0,r._)([(0,o.MZ)()],hr.prototype,"basemapTerrain",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],hr.prototype,"layerScaleEnabled",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],hr.prototype,"suspended",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],hr.prototype,"updating",null),(0,r._)([(0,o.MZ)()],hr.prototype,"_dirty",void 0),hr=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],hr);const cr="terrain-events",ur=(0,W.vt)();var pr=i(94643),yr=i(85632);const gr=[];(0,c.hA)();let vr=class extends E.A{constructor(e){super(e),this.drapeSourcePriorityOffset=0,this.type="graphics-3d",this.graphicsCore=null,this.drapeSourceType=R.Om.Features,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null,this._updatingHandles=new G.U}initialize(){const{layer:e}=this,t="effectiveScaleRange"in e?e:null,i=!(0,lr.j)()&&this.scaleVisibilityEnabled&&null!=t,r=new yi({owner:this,layer:this.owner.layer,preferredUpdatePolicy:ri.q.SYNC,graphicSymbolSupported:!0,componentFactories:{elevationAlignment:(e,t)=>new Ci({graphicsCoreOwner:this,graphicsCore:e,queryGraphicUIDsInExtent:t,elevationProvider:this.view.elevationProvider}),scaleVisibility:i?(e,i)=>new hr({graphicsCoreOwner:this,layer:t,queryGraphicUIDsInExtent:i,graphicsCore:e,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:e=>new or(e)}});if(this._set("graphicsCore",r),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new Qi({graphicsCoreOwner:this})),"fullOpacity"in this.owner){const e=this.owner;this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange())}if("elevationInfo"in e){const t=e;this._updatingHandles.add(()=>t.elevationInfo,(e,t)=>{(0,P.Ui)(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set("initializePromise",this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){try{await this.graphicsCore.initializePromise}catch(e){if((0,u.zf)(e))return;throw e}this.destroyed||(this.addHandles((0,a.wB)(()=>this.view.clippingArea,()=>this._updateClippingExtent(),a.OH)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",(0,n.pR)(this.frustumVisibility)),this._set("graphicsCore",(0,n.pR)(this.graphicsCore))}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.uid}get view(){return this.owner.view}get scaleVisibility(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.scaleVisibility}get elevationAlignment(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.elevationAlignment}get scaleVisibilitySuspended(){return!(null==this.scaleVisibility||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return null!=this.frustumVisibility&&this.frustumVisibility.suspended}get suspended(){var e;return null!==(e=this.owner.suspended)&&void 0!==e&&e}get updating(){var e;return!!(null!==(e=this.graphicsCore)&&void 0!==e&&e.updating||null!=this.scaleVisibility&&this.scaleVisibility.updating||null!=this.frustumVisibility&&this.frustumVisibility.updating||this._updatingHandles.updating)}get graphics3DGraphics(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return null!==(e=this.owner.fullOpacity)&&void 0!==e?e:1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){var e,t;null===(e=(t=this.owner).notifyContentGeometryUpdate)||void 0===e||e.call(t)}getRenderingInfo(e,t,i){const r=(0,L.vl)(e,{renderer:t,arcade:i});if(null!==r&&void 0!==r&&r.color){const e=r.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return r}getRenderingInfoAsync(e,t,i,r){return(0,L.LO)(e,(0,w.A)({renderer:t,arcade:i},r))}getHit(e){if(this.owner.loadedGraphics){const t=this.owner.loadedGraphics.find(t=>t.uid===e);if(t){const e=this.layer instanceof A.A?this.layer:null,i=(0,O.wP)(t,e);return{type:"graphic",graphic:i,layer:i.layer}}}return null}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){var t;const i=null===(t=this.graphicsCore)||void 0===t?void 0:t.objectStates;if(!i)return(0,c.hA)();const{set:r,handle:s}=i.acquireOccludeeSet(null);return i.setUid(r,e.uid),s}highlight(e,t){var i;const r=null===(i=this.graphicsCore)||void 0===i?void 0:i.objectStates;if(!r)return mr;if(e instanceof I.A)return mr;const s=function(e){return pr.A.isCollection(e)?e.toArray():Array.isArray(e)?e:function(e){return"number"==typeof e||"string"==typeof e}(e)||(0,yr.DU)(e)||function(e){return"esri.views.3d.layers.i3s.PointCloudGraphic"===e.declaredClass}(e)?[e]:gr}(e);if(0===s.length)return mr;if(s[0]instanceof x.A){const e=s.map(e=>e.uid),{set:i,handle:n}=r.acquireHighlightSet(t,null);return r.setUids(i,e),n}if("number"==typeof s[0]){const e=s,{set:i,handle:n}=r.acquireHighlightSet(t,null);return r.setObjectIds(i,e),n}return mr}_setupSuspendResumeExtent(){const{scaleVisibility:e,frustumVisibility:t}=this;if(null==e&&null==t)return;const i=i=>{let{computedExtent:r,extentPadding:s}=i;this._suspendResumeExtent=(0,Fe.t8)(r,this._suspendResumeExtent,D.qD,s),null!=e&&e.setExtent(this._suspendResumeExtent),null!=t&&t.setExtent(this._suspendResumeExtent)};this.addHandles((0,a.wB)(()=>{var e,t;return{computedExtent:null===(e=this.graphicsCore)||void 0===e?void 0:e.computedExtent,extentPadding:null===(t=this.graphicsCore)||void 0===t?void 0:t.extentPadding}},e=>i(e),a.pc))}_updateClippingExtent(){const e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};(0,r._)([(0,o.MZ)()],vr.prototype,"drapeSourcePriorityOffset",void 0),(0,r._)([(0,o.MZ)()],vr.prototype,"type",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],vr.prototype,"owner",void 0),(0,r._)([(0,o.MZ)()],vr.prototype,"layer",null),(0,r._)([(0,o.MZ)()],vr.prototype,"layerViewUid",null),(0,r._)([(0,o.MZ)()],vr.prototype,"view",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],vr.prototype,"graphicsCore",void 0),(0,r._)([(0,o.MZ)()],vr.prototype,"scaleVisibility",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],vr.prototype,"frustumVisibility",void 0),(0,r._)([(0,o.MZ)()],vr.prototype,"elevationAlignment",null),(0,r._)([(0,o.MZ)()],vr.prototype,"scaleVisibilitySuspended",null),(0,r._)([(0,o.MZ)({readOnly:!0})],vr.prototype,"frustumVisibilitySuspended",null),(0,r._)([(0,o.MZ)()],vr.prototype,"suspended",null),(0,r._)([(0,o.MZ)({readOnly:!0})],vr.prototype,"updating",null),(0,r._)([(0,o.MZ)()],vr.prototype,"loadedGraphics",null),(0,r._)([(0,o.MZ)()],vr.prototype,"fullOpacity",null),(0,r._)([(0,o.MZ)()],vr.prototype,"slicePlaneEnabled",null),(0,r._)([(0,o.MZ)()],vr.prototype,"drapeSourceType",void 0),(0,r._)([(0,o.MZ)()],vr.prototype,"updatePolicy",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],vr.prototype,"scaleVisibilityEnabled",void 0),(0,r._)([(0,o.MZ)({constructOnly:!0})],vr.prototype,"frustumVisibilityEnabled",void 0),(0,r._)([(0,o.MZ)()],vr.prototype,"initializePromise",void 0),vr=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.GraphicsProcessor")],vr);const mr=(0,c.hA)();const br={candidates:[],sourceCandidateIndices:[]};class _r{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=i,this.maximumFeatures=r,this.nodes=s,this.core=n}}var fr=i(91196),Sr=i(1723),Cr=i(53963);let wr=class extends(y(fr.A)){constructor(){super(...arguments),this.type="graphics-3d",this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.ignoresMemoryFactor=!0}get highlightOptions(){return null}initialize(){this._set("processor",new vr({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.addHandles(this.layer.on("graphic-update",e=>this.processor.graphicsCore.graphicUpdateHandler(e))),this.layer.internal?this.notifyChange("updating"):("local"===this.view.viewingMode&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await(0,Cr.n)(this.layer.fullExtent,this.view.spatialReference))()),this.addHandles((0,a.z7)(()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.ready},()=>()=>this.notifyChange("updating"),{once:!0})))}destroy(){this._updatingHandles.removeAll(),this._set("processor",(0,n.pR)(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){var e;return this.canResume()&&!(null!==(e=this.processor)&&void 0!==e&&e.frustumVisibilitySuspended)}get visibleAtCurrentScale(){var e;return(0,lr.j)()?(0,lr.E5)(this.layer.effectiveScaleRange,this.view.scale):!(null!==(e=this.processor)&&void 0!==e&&e.scaleVisibilitySuspended)}get slicePlaneEnabled(){const e=this.layer.internal;return this._slicePlaneEnabled&&!e}set slicePlaneEnabled(e){this._slicePlaneEnabled=e}getSuspendInfo(){var e,t;const i=super.getSuspendInfo();return i.outsideOfView=null!==(e=null===(t=this.processor)||void 0===t?void 0:t.frustumVisibilitySuspended)&&void 0!==e&&e,i}getHit(e){return this.processor.getHit(e)}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return null===(i=this.processor)||void 0===i?void 0:i.computeAttachmentOrigin(e,t)}getSymbolLayerSize(e,t){return this.processor.getSymbolLayerSize(e,t)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e,t){var i;return this.processor.highlight(e,null!==(i=null===t||void 0===t?void 0:t.name)&&void 0!==i?i:Sr.Tv)}notifyContentGeometryUpdate(){this.emit("visible-geometry-changed")}async elevationAlignPointsInFeatures(e,t){const{processor:i}=this;if(null==(null===i||void 0===i?void 0:i.graphics3DGraphics))throw new s.A("graphicslayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");const{graphics3DGraphics:r}=i;return async function(e,t,i,r,s){var n;const{elevationProvider:a,renderCoordsHelper:o}=e,{elevationInfo:l}=t,{pointsInFeatures:h,spatialReference:d}=r,c=v.A.fromJSON(d),p=(0,C.MF)(l,!0),y=await(0,C.q6)(p,c,s);(0,u.Te)(s);const w=[],x=new Set,E=new Set,P=new S.F,G=(0,b.T)(0,0,0,v.A.WGS84),A=new f.Uk,O=(0,g.vt)();G.spatialReference=c;const L=null!==(n=e.elevationProvider.spatialReference)&&void 0!==n?n:e.spatialReference;for(const{objectId:u,points:g}of h){const e=i(u);if(null==e){for(const e of g){var I;w.push(null!==(I=e.z)&&void 0!==I?I:0)}x.add(u);continue}e.isDraped&&E.add(u);const r=e.graphic.geometry;P.setFromElevationInfo((0,_.ze)(r,l)),P.updateFeatureExpressionInfoContext(y,e.graphic,t);for(const{x:t,y:i,z:n}of g)G.x=t,G.y=i,G.z=null!==n&&void 0!==n?n:0,await(0,m.W)(G,O,L,0,{signal:s}),(0,f.sE)(O,a,P,o,A),w.push(A.z)}return{elevations:w,drapedObjectIds:E,failedObjectIds:x}}(this.view,this.layer,e=>"number"==typeof e?r.get(e):void 0,e,t)}async queryForSymbologySnapping(e,t){return async function(e,t,i){var r;if(null==e||0===t.candidates.length)return br;const s=null!==(r=e.graphics3DGraphicsByObjectID)&&void 0!==r?r:e.graphics3DGraphics,n=[],a=[],{renderer:o}=e,l=null!=o&&"arcadeRequired"in o&&o.arcadeRequired?(0,se.l)():null,h=async(t,r)=>{let{graphic:s,graphics3DSymbol:n}=r;const a=await l,h=await e.getRenderingInfoAsync(s,o,a,{signal:i});return null==h?[]:n.queryForSnapping(t,c,h,i)},{candidates:d,spatialReference:c}=t;for(let u=0;u<d.length;++u){const e=d[u],{objectId:t}=e,i="number"==typeof t?null===s||void 0===s?void 0:s.get(t):void 0;if(null==i)continue;const{graphics3DSymbol:r}=i;r.symbologySnappingSupported&&(n.push(h(e,i)),a.push(u))}if(0===n.length)return br;const p=await Promise.all(n);(0,u.Te)(i);const y=[],g=[];for(let u=0;u<p.length;++u){const e=p[u],t=a[u];for(const i of e)y.push(i),g.push(t)}return{candidates:y,sourceCandidateIndices:g}}(this.processor,e,t)}get updatePolicy(){var e;return(null===(e=this.processor)||void 0===e?void 0:e.graphicsCore.effectiveUpdatePolicy)||ri.q.SYNC}isUpdating(){var e,t;return this.view&&this.layer&&!((null===(e=this.processor)||void 0===e||!e.updating)&&(this.layer.internal||null!==(t=this.view.basemapTerrain)&&void 0!==t&&t.ready))}get performanceInfo(){return new _r(this.usedMemory,this.loadedGraphics.length,-1,-1)}get usedMemory(){var e,t;return null!==(e=null===(t=this.processor)||void 0===t||null===(t=t.graphicsCore)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}get unloadedMemory(){var e;return null===(e=this.processor)||void 0===e||null===(e=e.graphicsCore)||void 0===e?void 0:e.unprocessedMemoryEstimate}get test(){return{graphics3DProcessor:this.processor,loadedGraphics:this.loadedGraphics}}};(0,r._)([(0,o.MZ)()],wr.prototype,"highlightOptions",null),(0,r._)([(0,o.MZ)()],wr.prototype,"loadedGraphics",null),(0,r._)([(0,o.MZ)({readOnly:!0})],wr.prototype,"legendEnabled",null),(0,r._)([(0,o.MZ)()],wr.prototype,"layer",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],wr.prototype,"processor",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],wr.prototype,"visibleAtCurrentScale",null),(0,r._)([(0,o.MZ)()],wr.prototype,"_slicePlaneEnabled",void 0),(0,r._)([(0,o.MZ)({type:Boolean})],wr.prototype,"slicePlaneEnabled",null),wr=(0,r._)([(0,d.$)("esri.views.3d.layers.GraphicsLayerView3D")],wr);const xr=wr},40431:(e,t,i)=>{i.d(t,{L:()=>L,b:()=>A});var r,s,n,a,o,l,h,d=i(57528),c=i(19555),u=i(72745),p=i(55855),y=i(26917),g=i(98720),v=i(40318),m=i(62374),b=i(10708),_=i(69817),f=i(28450),S=i(95756),C=i(51596),w=i(58350),x=i(21390),E=i(86955),P=i(66470),G=i(2687);function A(e){const t=new G.N5,{vertex:i,fragment:u}=t,{terrainDepthTest:A}=e;return i.include(g.K),t.include(v.Q,e),t.vertex.include(y.rA,e),t.attributes.add(P.r.UV0,"vec2"),i.uniforms.add(new C.I("viewport",e=>e.camera.fullViewport),new x.m("lineSize",(e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0),new f.E("pixelToNDC",e=>(0,c.hZ)(O,2/e.camera.fullViewport[2],2/e.camera.fullViewport[3])),new x.m("borderSize",(e,t)=>e.borderColor?t.camera.pixelRatio:0),new S.G("screenOffset",(e,t)=>(0,c.hZ)(O,e.horizontalScreenOffset*t.camera.pixelRatio,0))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),A&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include(m.y),e.hasScreenSizePerspective&&(0,_.OH)(i),i.main.add((0,E.H)(r||(r=(0,d.A)(["\n    ProjectHUDAux projectAux;\n    vec4 endPoint = projectPositionHUD(projectAux);\n\n    vec3 vpos = projectAux.posModel;\n    if (rejectBySlice(vpos)) {\n      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n      return;\n    }\n    ","\n\n    ","\n    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the\n    // correct depth value\n    vec3 posView = (view * vec4(position, 1.0)).xyz;\n    ","\n\n    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);\n    vec4 startPoint = proj * vec4(posView, 1.0);\n\n    // Apply screen offset to both start and end point\n    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;\n    startPoint.xy += screenOffsetNorm * startPoint.w;\n    endPoint.xy += screenOffsetNorm * endPoint.w;\n\n    // Align start and end to pixel origin\n    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);\n    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);\n    ","\n    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);\n\n    // The direction of the line in screen space\n    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);\n    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);\n    ","\n    float halfPixelSize = lineSizeScaled * 0.5;\n\n    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size\n    float padding = 1.0 + borderSizeScaled;\n    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;\n\n    // Offset x/y from the center of the line in screen space\n    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;\n\n    // Compute a coverage varying which we can use in the fragment shader to determine\n    // how much a pixel is actually covered by the line (i.e. to anti alias the line).\n    // This works by computing two coordinates that can be linearly interpolated and then\n    // subtracted to find out how far away from the line edge we are.\n    float edgeDirection = (uv0.x * 2.0 - 1.0);\n\n    float halfBorderSize = 0.5 * borderSizeScaled;\n    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;\n    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);\n\n    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);\n\n    coverageSampling = vec4(\n      // Edge coordinate\n      outerEdgeCoverageSampler,\n\n      // Border edge coordinate\n      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,\n\n      // Line offset\n      halfPixelSize - 0.5,\n\n      // Border offset\n      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)\n    );\n\n    lineSizes = vec2(lineSizeScaled, borderSizeScaled);\n    gl_Position = projectedPosition;"])),(0,E.If)(e.occlusionTestEnabled,(0,E.H)(s||(s=(0,d.A)(["if (!testHUDVisibility(endPoint)) {\n             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n             return;\n           }"])))),e.hasScreenSizePerspective?(0,E.H)(n||(n=(0,d.A)(["vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);"]))):"vec2 screenOffsetScaled = screenOffset;",(0,E.If)(A,"depth = posView.z;"),(0,E.If)(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);"),e.hasScreenSizePerspective?(0,E.H)(a||(a=(0,d.A)(["float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);\n               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);"]))):(0,E.H)(o||(o=(0,d.A)(["float lineSizeScaled = lineSize;\n               float borderSizeScaled = borderSize;"]))))),u.uniforms.add(new w.E("uColor",e=>{var t;return null!==(t=e.color)&&void 0!==t?t:p.uY}),new w.E("borderColor",e=>{var t;return null!==(t=e.borderColor)&&void 0!==t?t:p.uY})),A&&(u.include(b.H,e),u.uniforms.add(new f.E("inverseViewport",e=>e.inverseViewport))),u.main.add((0,E.H)(l||(l=(0,d.A)(["\n    ","\n\n    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);\n\n    float borderAlpha = uColor.a * borderColor.a * coverage.y;\n    float colorAlpha = uColor.a * coverage.x;\n\n    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);\n    ",""])),(0,E.If)(A,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }"),(0,E.If)(!e.hudDepth,(0,E.H)(h||(h=(0,d.A)(["vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);\n           fragColor = vec4(finalRgb, finalAlpha);"])))))),t}const O=(0,u.vt)(),L=Object.freeze(Object.defineProperty({__proto__:null,build:A},Symbol.toStringTag,{value:"Module"}))},41854:(e,t,i)=>{var r,s;i.d(t,{G:()=>s,w:()=>r}),function(e){e[e.RecreateSymbol=0]="RecreateSymbol",e[e.RecreateGraphics=1]="RecreateGraphics",e[e.FastUpdate=2]="FastUpdate"}(r||(r={})),function(e){e[e.Slow=0]="Slow",e[e.Fast=1]="Fast",e[e.Mixed=2]="Mixed",e[e.Loading=3]="Loading",e[e.Undefined=4]="Undefined"}(s||(s={}))},48989:(e,t,i)=>{i.d(t,{Eg:()=>u,GI:()=>m,JV:()=>v,Tf:()=>p,k9:()=>y,pg:()=>b,uD:()=>c});var r=i(89379),s=i(4212),n=i(47675),a=i(64573),o=i(73177),l=i(90346),h=i(50809),d=i(65131);const c=new l.hk({});function u(e){return"web-style"===e.type?c:p(e.symbolLayers.toArray().map(t=>v(e,t)))}function p(e){let t=0,i=0,r=0,s=!1,n=0;const a=new l.i3;for(const o of e)null!=o&&(t+=o.verticesPerFeature,i+=o.verticesPerCoordinate,r+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.resourceBytes+=o.memory.resourceBytes,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,s=s||o.estimated,++n);return s?new l.a8(n,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a}):new l.MT(n,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a})}function y(e){const t=p(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}const g={};function v(e,t){var i,c,u;const p=m(e,t),y=(0,h.RF)(t)?2:0;switch(t.type){case"extrude":return new l.rz({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:y,memory:p});case"fill":if("mesh-3d"===e.type)return new l.rz({drawCallsPerFeature:y,memory:p});if(null!=t.outline&&t.outline.size>0)return new l.rz({verticesPerFeature:-12,verticesPerCoordinate:9,memory:p});case"water":return new l.rz({verticesPerFeature:-6,verticesPerCoordinate:3,memory:p});case"line":return new l.rz({verticesPerFeature:-6,verticesPerCoordinate:6,memory:p});case"object":return null!==(i=t.resource)&&void 0!==i&&i.href?new l.hk({verticesPerFeature:100,memory:p}):(0,r.A)((0,r.A)({},function(e){const t=g[e];if(t)return t;const i=b((0,o._)(e,new d.$U({},{spherical:!0})).levels);return g[e]=new l.rz({verticesPerFeature:i}),g[e]}(null!==(c=null===(u=t.resource)||void 0===u?void 0:u.primitive)&&void 0!==c?c:n.r)),{},{memory:p});case"path":{let e=0,i=0;switch(t.profile){case"circle":e=a.ZC;break;case"quad":e=4;break;default:return void(0,s.Xb)(t.profile)}switch(t.join){case"round":i=a.kf;break;case"miter":case"bevel":i=1;break;default:return}const r=2*e,n=e*i*2,o=n+r;let h=-2*n-r;switch(t.cap){case"none":break;case"butt":case"square":h+=2*(e-1);break;case"round":h+=2*(e*(a.RL-1)*2+e);break;default:return}return new l.rz({verticesPerFeature:h,verticesPerCoordinate:o,memory:p})}case"text":{const t="label-3d"===e.type?0:2;return new l.rz({verticesPerFeature:6,memory:p,drawCallsPerFeature:t})}case"icon":return new l.rz({verticesPerFeature:6,memory:p});default:return}}function m(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?_.EXTRUDE_EDGES:_.EXTRUDE;case"fill":return null!=t.outline&&t.outline.size>0?_.FILL_OUTLINE:_.FILL;case"water":return _.FILL;case"line":return"round"===t.join?_.LINE_ROUND:_.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return _.PATH_ROUND_CIRCLE;case"quad":return _.PATH_ROUND_QUAD;default:return void(0,s.Xb)(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return _.PATH_MITER_CIRCLE;case"quad":return _.PATH_MITER_QUAD;default:return void(0,s.Xb)(t.profile)}default:return}case"object":return i?_.OBJECT_POINT:_.OBJECT_POLYGON;case"icon":case"text":return i?_.ICON_POINT:_.ICON_POLYGON;default:return}}function b(e){return e.reduce((e,t,i)=>e+t.numVertices*(1/10**i),0)/e.reduce((e,t,i)=>e+1/10**i,0)}const _={ICON_POINT:{bytesPerFeature:3062.2534325974652,bytesPerFeatureLabel:3605.891255,resourceBytes:0,draped:{bytesPerFeature:2029.6324697040875,bytesPerFeatureLabel:3844.951315}},ICON_POLYGON:{bytesPerFeature:3379.2552364427283,bytesPerFeatureLabel:3144.1341316666667,resourceBytes:0,draped:{bytesPerFeature:2594.5439970589305,bytesPerFeatureLabel:3391.0192816666668}},OBJECT_POINT:{bytesPerFeature:755.5754513856272,bytesPerFeatureLabel:3229.7766,resourceBytes:0,draped:{bytesPerFeature:755.5754513856272,bytesPerFeatureLabel:3229.7766}},OBJECT_POLYGON:{bytesPerFeature:1235.9612556276838,bytesPerFeatureLabel:2710.5796950000004,resourceBytes:0,draped:{bytesPerFeature:1235.9612556276838,bytesPerFeatureLabel:2710.5796950000004}},LINE_MITER:{bytesPerFeature:2343.0098144295366,bytesPerFeatureLabel:2863.2415183333333,resourceBytes:0,draped:{bytesPerFeature:2118.062960542706,bytesPerFeatureLabel:2993.8707950000003}},LINE_ROUND:{bytesPerFeature:3180.281669156425,bytesPerFeatureLabel:2884.062711666667,resourceBytes:0,draped:{bytesPerFeature:2687.1048133674676,bytesPerFeatureLabel:2965.844025}},PATH_MITER_CIRCLE:{bytesPerFeature:26642.015762630304,bytesPerFeatureLabel:3147.8341749999995,resourceBytes:0,draped:{bytesPerFeature:26642.015762630304,bytesPerFeatureLabel:3147.8341749999995}},PATH_ROUND_CIRCLE:{bytesPerFeature:21137.659435445064,bytesPerFeatureLabel:2827.1294000000003,resourceBytes:0,draped:{bytesPerFeature:21137.659435445064,bytesPerFeatureLabel:2827.1294000000003}},PATH_MITER_QUAD:{bytesPerFeature:25592.283303929427,bytesPerFeatureLabel:3354.641775,resourceBytes:0,draped:{bytesPerFeature:25592.283303929427,bytesPerFeatureLabel:3354.641775}},PATH_ROUND_QUAD:{bytesPerFeature:23212.92773696872,bytesPerFeatureLabel:3173.6644499999998,resourceBytes:0,draped:{bytesPerFeature:23212.92773696872,bytesPerFeatureLabel:3173.6644499999998}},FILL:{bytesPerFeature:3069.6014181747005,bytesPerFeatureLabel:3050.617135,resourceBytes:0,draped:{bytesPerFeature:2547.9765396831167,bytesPerFeatureLabel:3166.2821483333337}},FILL_OUTLINE:{bytesPerFeature:3653.779598313774,bytesPerFeatureLabel:2787.5897050000003,resourceBytes:0,draped:{bytesPerFeature:2884.528596112384,bytesPerFeatureLabel:2907.420548333333}},EXTRUDE:{bytesPerFeature:5785.658350054202,bytesPerFeatureLabel:2787.498365,resourceBytes:0,draped:{bytesPerFeature:5785.658350054202,bytesPerFeatureLabel:2787.498365}},EXTRUDE_EDGES:{bytesPerFeature:3380.451670091342,bytesPerFeatureLabel:2245.881308333333,resourceBytes:0,draped:{bytesPerFeature:3380.451670091342,bytesPerFeatureLabel:2245.881308333333}}}},64573:(e,t,i)=>{i.d(t,{RL:()=>s,ZC:()=>n,kf:()=>r});const r=3,s=3,n=10},75646:(e,t,i)=>{i.d(t,{P:()=>r,x:()=>a});var r,s=i(30726),n=i(50346);class a{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=r.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){var i,s;return this._loadStatus===r.LOADED?(e&&e(),null!==(i=this._loader)&&void 0!==i?i:Promise.resolve()):this._loadStatus===r.FAILED?(t&&t(this._loadError),null!==(s=this._loader)&&void 0!==s?s:Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=r.LOADED},e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=r.FAILED,!(0,n.zf)(e)&&this.logger&&e.message&&this.logger.warn(e.message),e})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){null!=this._abortController?this._abortController=(0,s.DC)(this._abortController):this._loadStatus===r.LOADING&&(this._loadStatus=r.FAILED),this._loader=null}}!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"}(r||(r={}))},86486:(e,t,i)=>{i.d(t,{LO:()=>o,kg:()=>l,or:()=>h,vl:()=>a});var r=i(69539),s=i(11687),n=i(15492);function a(e,t){var i;const r=function(e,t){if(null!=e.symbol)return e.symbol;const i=null===t||void 0===t?void 0:t.renderer;return null!=i&&"dot-density"!==i.type?i.getSymbol(e,t):null}(e,t);if(null==r)return null;const a=null===t||void 0===t?void 0:t.renderer,o=new s.$(a,r);if(null==a||!("visualVariables"in a)||!a.visualVariables)return o;const l=null!==(i=(0,n.getVisualVariableValues)(a,e,t))&&void 0!==i?i:[],h=["proportional","proportional","proportional"];for(const{variable:s,value:n}of l)if(null!=n||"size"===s.type&&s.useSymbolValue)switch(s.type){case"color":o.color=null===n||void 0===n?void 0:n.toRgba();break;case"size":if("outline"===s.target)o.outlineSize=n;else{const e=s.axis,t=s.useSymbolValue?"symbol-value":null!==n&&void 0!==n?n:"proportional";switch(e){case"width":h[0]=t;break;case"depth":h[1]=t;break;case"height":h[2]=t;break;case"width-and-depth":h[0]=h[1]=t;break;default:h[0]=h[1]=h[2]=t}}break;case"opacity":o.opacity=n;break;case"rotation":switch(s.axis){case"tilt":o.tilt=n;break;case"roll":o.roll=n;break;default:o.heading=n}}return"proportional"===h[0]&&"proportional"===h[1]&&"proportional"===h[2]||(o.size=h),o}async function o(e,t){var i;const a=await async function(e,t){var i,r;return null!=e.symbol?e.symbol:null!==(i=null===t||void 0===t||null===(r=t.renderer)||void 0===r?void 0:r.getSymbolAsync(e,t))&&void 0!==i?i:null}(e,t);if(!a)return null;const o=null===t||void 0===t?void 0:t.renderer,l=new s.$(o,a);if(!o||!("visualVariables"in o)||!o.visualVariables)return l;const h=null!==(i=(0,n.getVisualVariableValues)(o,e,t))&&void 0!==i?i:[],d=["proportional","proportional","proportional"];for(const{variable:s,value:n}of h)if("color"===s.type)l.color=r.A.toUnitRGBA(n);else if("size"===s.type)if("outline"===s.target)l.outlineSize=n;else{const e=s.axis,t=s.useSymbolValue?"symbol-value":n;"width"===e?d[0]=t:"depth"===e?d[1]=t:"height"===e?d[2]=t:d[0]=d[1]="width-and-depth"===e?t:d[2]=t}else"opacity"===s.type?l.opacity=n:"rotation"===s.type&&"tilt"===s.axis?l.tilt=n:"rotation"===s.type&&"roll"===s.axis?l.roll=n:"rotation"===s.type&&(l.heading=n);return(isFinite(d[0])||isFinite(d[1])||isFinite(d[2]))&&(l.size=d),l}function l(e){const t=e[arguments.length>1&&void 0!==arguments[1]?arguments[1]:0];return"number"==typeof t&&isFinite(t)?t:null}function h(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}},88265:(e,t,i)=>{i.d(t,{R$:()=>v,SZ:()=>c,ZX:()=>g,d2:()=>y,hS:()=>u});var r=i(9392),s=i(64232),n=i(42294),a=i(5262),o=i(18117),l=i(67425),h=i(36423),d=i(37046);function c(e,t,i,r,s){if(p(e,t))return null;i.localOrigin=v(e,t);const n=new d.B({geometries:[i],castShadow:!1,layerViewUid:e.layerViewUid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:n,sampledElevation:(0,l.fe)(n,t,e.elevationProvider,e.renderCoordsHelper,r)}}function u(e,t,i,r){return p(t,i)?null:(0,l.fe)(e,i,t.elevationProvider,t.renderCoordsHelper,r)}function p(e,t){const i=e.clippingExtent;return!!i&&((0,s.g)(t,m,e.elevationProvider.spatialReference),!(0,n.Uc)(i,m))}function y(e,t,i){const r=e.elevationContext,n=i.spatialReference;(0,s.g)(t,m,n),r.centerPointInElevationSR=(0,o.T)(m[0],m[1],t.hasZ?m[2]:0,null!=n?n:null)}function g(e){switch(e.type){case"point":return e;case"polygon":case"extent":return(0,h.W$)(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,a.$H)(t,(0,a.Yl)(t)/2);return(0,o.T)(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.extent.center}return null}function v(e,t){return(0,s.g)(t,m,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(m)}const m=(0,r.vt)()},90346:(e,t,i)=>{i.d(t,{MT:()=>n,a8:()=>a,hk:()=>s,i3:()=>o,rz:()=>r});class r{constructor(e){var t,i,r,s;this.estimated=!1,this.verticesPerFeature=null!==(t=e.verticesPerFeature)&&void 0!==t?t:0,this.verticesPerCoordinate=null!==(i=e.verticesPerCoordinate)&&void 0!==i?i:0,this.drawCallsPerFeature=null!==(r=e.drawCallsPerFeature)&&void 0!==r?r:0,this.memory=null!==(s=e.memory)&&void 0!==s?s:new o}}class s extends r{constructor(e){super(e),this.estimated=!0}}class n extends r{constructor(e,t){super(t),this.numComplexities=e}}class a extends s{constructor(e,t){super(t),this.numComplexities=e}}class o{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}},99057:(e,t,i)=>{i.d(t,{H:()=>u,Y:()=>p});var r=i(20664),s=i(9392),n=i(42294),a=i(78315),o=i(67425),l=i(41595),h=i(36423),d=i(83490),c=i(46702);class u{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=i}}class p{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,r,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=i,this.elevationAligner=r,this.elevationContext=s,this._edgeState=n,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){var e,t;if(!this._stageLayer)return;const i=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),null!==(e=i.renderer.edgeView)&&void 0!==e&&e.removeObject(this.stageObject),this.stageObject.dispose(),null!==(t=this._sharedResource)&&void 0!==t&&t.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:i,_edgeState:r,_stageLayer:s}=this;if(null==r)return;const n=y(r.baseMaterial);r.edgeMaterial.objectTransparency!==n&&(r.edgeMaterial.objectTransparency=n,this.resetEdgeObject(t)),s.stage.renderer.withEdgeView(t=>t.updateAllComponentOpacities(i,[e]))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:i,_edgeState:r,_stageLayer:s}=this;null!=r&&s.stage.renderer.withEdgeView(s=>{s.updateAllComponentMaterials(i,r.edgeMaterial,e,!t),r.hasSlicePlane=e})}setVisibility(e){const{_edgeState:t,stageObject:i,_stageLayer:r}=this;null!=r&&this.visible!==e&&(this._visible=e,i.visible=e,e&&!this._addedToStage&&(r.add(i),this._addedToStage=!0),null!=t&&r.stage.renderer.withEdgeView(r=>{r.hasObject(i)?r.updateObjectVisibility(i,e):e&&this._addOrUpdateEdgeObject(t,r,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,i,r){if(null==this.elevationAligner)return;null!=i&&(0,l.gf)(this.elevationContext.featureExpressionInfoContext,i);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,(i,r)=>(0,o.sE)(i,e,this.elevationContext,t,r),t),this.resetEdgeObject(r)}alignWithAbsoluteElevation(e,t,i){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(t,i)=>{i.sampledElevation=e,i.verticalDistanceToGround=0,i.z=e},t),this.resetEdgeObject(i)}getCenterObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,s.vt)();return(0,r.c)(e,(0,a.a)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,n.vt)();const t=this.stageObject.boundingVolumeObjectSpace;return(0,n.Ne)(e,t.min),(0,n.vI)(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(m)&&((0,r.t)(m,m,t),(0,r.f)(e.render.origin,e.render.origin,m),e.render.num++)}async getProjectedBoundingBox(e,t,i,s,a){const o=this.getBoundingBoxObjectSpace(a),l=b,d=(0,n.fT)(o)?1:l.length;for(let n=0;n<d;n++){const e=l[n];v[0]=o[e[0]],v[1]=o[e[1]],v[2]=o[e[2]],(0,r.t)(v,v,this.stageObject.transformation),g[3*n]=v[0],g[3*n+1]=v[1],g[3*n+2]=v[2]}if(!e(g,0,d))return null;(0,n.Ie)(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let r=0;r<3*d;r+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],g[r+e]),o[e+3]=Math.max(o[e+3],g[r+e]);c&&i.push({location:g.slice(r,r+3),screenSpaceBoundingRect:c})}if(null!==t&&void 0!==t&&t.service&&"absolute-height"!==this.elevationContext.mode){var u;(0,n.gX)(o,m);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=null!==(u=t.service.getElevation(m[0],m[1],e))&&void 0!==u?u:0;else try{var p;const r=(0,h.vY)(o,t.service.spatialReference,t);i=null!==(p=await t.service.queryElevation(m[0],m[1],s,r,e))&&void 0!==p?p:0}catch(y){}(0,n.cY)(o,0,0,-this.alignedSampledElevation+i)}return o}addObjectState(e){e.stateType===d.Mg.Highlight&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),e.stateType===d.Mg.MaskOccludee&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:i,_stageLayer:r,_visible:s}=this;null!=t&&r.stage.renderer.withEdgeView(r=>{s?this._addOrUpdateEdgeObject(t,r,e):r.removeObject(i)})}_addOrUpdateEdgeObject(e,t,i){const r=y(e.baseMaterial);e.edgeMaterial.objectTransparency=r,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!i).then(()=>{var e;return null===(e=this._stageLayer)||void 0===e?void 0:e.sync()})}}function y(e){return e.transparent?c.x.TRANSPARENT:c.x.OPAQUE}const g=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],v=(0,s.vt)(),m=(0,s.vt)(),b=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]]}}]);
//# sourceMappingURL=179.94c24b61.chunk.js.map