"use strict";(self.webpackChunkstreamlit_geomap_frontend=self.webpackChunkstreamlit_geomap_frontend||[]).push([[7960],{67960:(e,t,i)=>{i.r(t),i.d(t,{SelfSnappingEngine:()=>N});var s=i(35143),r=i(91967),n=i(94643),o=i(46053),h=(i(81806),i(76460),i(47249),i(85842)),a=i(73582),d=i(24648),l=i(9392),c=i(12482),p=i(23862),g=i(31633),u=i(19555),f=i(63078),v=i(70330),x=i(17072);class L{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=f.N.shortLineThreshold*f.N.shortLineThreshold}snap(e,t){return null!=t.vertexHandle?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold((0,p.Lp)(e.leftVertex.pos,this.view,t),(0,p.Lp)(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,i){let{spatialReference:s}=i;return 0===this.squaredShortLineThreshold||(0,v.pM)((0,x.j)(t,s,c.qt,this.view),(0,x.j)(e,s,c.qt,this.view))>this.squaredShortLineThreshold}isVertical(e,t,i){let{spatialReference:s}=i;const r=(0,g.GA)(s);return(0,u.Io)((0,p.Xz)(e),(0,p.Xz)(t))*r<f.N.verticalLineThresholdMeters}squaredProximityThreshold(e){return"touch"===e?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}var E=i(45633),_=i(89646),w=i(79337),m=i(74050);class V extends L{constructor(e,t,i){super(e,t),this._geodesicLengthMeasurementUtils=i}snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:n}=t,o=(0,x.j)(e,n,c.qt,this.view),{view:h}=this,a=i.edges[s-1];let d=a;do{if(this.edgeExceedsShortLineThreshold(d,t)){const i=(0,v.is)(d,h,t);this._processCandidateProposal(i.left,i.right,e,o,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==a);return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:n}=this,{spatialReference:o}=t,h=(0,x.j)(e,o,c.qt,n),a=s.leftEdge,d=s.rightEdge;a&&d&&this.edgeExceedsShortLineThreshold(a,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal((0,p.Lp)(a.leftVertex.pos,n,t),(0,p.Lp)(d.rightVertex.pos,n,t),e,h,t,i);const l=r.edges[0];let g=l;do{if(g!==s.leftEdge&&g!==s.rightEdge&&this.edgeExceedsShortLineThreshold(g,t)){const s=(0,v.is)(g,n,t);this._processCandidateProposal(s.left,s.right,e,h,t,i)}g=g.rightVertex.rightEdge}while(g&&g!==l);return i}_processCandidateProposal(e,t,i,s,r,n){var o;const{spatialReference:h,pointer:g}=r,u=(0,l.vt)();!function(e,t,i,s,r,n){(function(e,t,i,s,r,n){let{spatialReference:o}=r;const h=(0,_.IP)(t,i,o,o);if(null==h)return!1;const l=(0,_.IP)(i,s,o,o);if(null==l)return!1;const c=n.geodesicDistance(i,s,o);if(null==c)return!1;const p=Math.abs(a.wf.shortestSignedDiff(h,l))>Math.PI/2?a.uC.normalize(h+Math.PI):h;return(0,_.rT)(e,i,o,(0,d.l3)(c,"meters"),(0,d.Wq)(p,"radians","geographic"),"geodesic"),e[2]=s[2],!0})(e,t,i,s,r,n)||function(e,t,i,s){(0,w.Yv)(t,{start:i,end:s,type:m.Vv.LINE},e),e[2]=t[2]}(e,s,t,i)}(u,e,t,i,r,this._geodesicLengthMeasurementUtils);const f=(0,p.de)((0,p._7)(u));(0,v.pM)(s,(0,x.j)(f,h,c.qt,this.view))<this.squaredProximityThreshold(g)&&n.push(new E.o({lineStart:e,lineEnd:t,targetPoint:f,isDraped:"on-the-ground"===(null===(o=r.elevationInfo)||void 0===o?void 0:o.mode)}))}}var P=i(72745),T=i(20612);class y extends L{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,n=[];if(s<2)return n;const{view:o}=this,h=(0,x.j)(e,t.spatialReference,c.qt,o),a=(0,p.Lp)(i.vertices[r-1].pos,o,t),d=(0,p.Lp)(i.vertices[0].pos,o,t),l=i.edges[s-1];let g=l;do{if(this.edgeExceedsShortLineThreshold(g,t)){const i=(0,v.is)(g,o,t);this._checkEdgeForParallelLines(i,a,e,h,t,n),this._checkEdgeForParallelLines(i,d,e,h,t,n)}g=g.leftVertex.leftEdge}while(g&&g!==l);return n}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:n}=this,o=(0,x.j)(e,t.spatialReference,c.qt,n),h=s.leftEdge,a=s.rightEdge,d=r.vertices[0],l=(0,p.Lp)(d.pos,n,t),g=r.vertices.length,u=r.vertices[g-1],f=(0,p.Lp)(u.pos,n,t),L=r.edges[0];let E=L;do{if(E!==h&&E!==a&&this.edgeExceedsShortLineThreshold(E,t)){const r=(0,v.is)(E,n,t);h&&this._checkEdgeForParallelLines(r,(0,p.Lp)(h.leftVertex.pos,n,t),e,o,t,i),a&&this._checkEdgeForParallelLines(r,(0,p.Lp)(a.rightVertex.pos,n,t),e,o,t,i),s===d?this._checkEdgeForParallelLines(r,f,e,o,t,i):s===u&&this._checkEdgeForParallelLines(r,l,e,o,t,i)}E=E.rightVertex.rightEdge}while(E&&E!==L);return i}_checkEdgeForParallelLines(e,t,i,s,r,n){const o=e.left,h=e.right;if((0,m.fg)(S,(0,p.Xz)(t),(0,p.Xz)(o),(0,p.Xz)(h)),(0,u.hG)(S,(0,p.Xz)(t))<f.N.parallelLineThreshold)return;(0,m.fg)(S,(0,p.Xz)(i),(0,p.Xz)(o),(0,p.Xz)(h),(0,p.Xz)(t));const{spatialReference:a,pointer:d}=r,l=(0,p.de)((0,p.fA)(S[0],S[1],i[2]));if((0,v.pM)(s,(0,x.j)(l,a,c.qt,this.view))<this.squaredProximityThreshold(d)){var g;if(this.isVertical(l,t,r)||this.isVertical(o,h,r))return;if(function(e,t){const i=e.left,s=e.right;for(const r of t)if((0,m.fg)(S,(0,p.Xz)(s),(0,p.Xz)(r.constraint.start),(0,p.Xz)(r.constraint.end),(0,p.Xz)(i)),(0,u.hG)(S,(0,p.Xz)(s))<f.N.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}(e,n))return;n.push(new T.B({referenceLine:e,lineStart:t,targetPoint:l,isDraped:"on-the-ground"===(null===(g=r.elevationInfo)||void 0===g?void 0:g.mode)}))}}}const S=(0,P.vt)();var q=i(20664),z=i(75543),X=i(78228);class M extends L{constructor(e,t,i){super(e,t),this._geodesicLengthMeasurementUtils=i}snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[];if(i.vertices.length<2)return s;const{view:r}=this,n=(0,x.j)(e,t.spatialReference,c.qt,r),o=i.vertices.at(-1);this._checkForSnappingCandidate(X._b.LastVertex,s,o.leftEdge,o,o.leftEdge.leftVertex,e,n,t);const h=i.vertices[0];return this._checkForSnappingCandidate(X._b.FirstVertex,s,h.rightEdge,h,h.rightEdge.rightVertex,e,n,t),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,n=(0,x.j)(e,t.spatialReference,c.qt,r),o=s.leftEdge,h=s.rightEdge;if(null!==o&&void 0!==o&&o.leftVertex.leftEdge){const s=o.leftVertex.leftEdge;this._checkForSnappingCandidate(X._b.ExistingEdge,i,s,s.rightVertex,s.leftVertex,e,n,t)}if(null!==h&&void 0!==h&&h.rightVertex.rightEdge){const s=h.rightVertex.rightEdge;this._checkForSnappingCandidate(X._b.ExistingEdge,i,s,s.leftVertex,s.rightVertex,e,n,t)}return i}_checkForSnappingCandidate(e,t,i,s,r,n,o,h){if(!this.edgeExceedsShortLineThreshold(i,h))return;const c=this.view,g=(0,p.Lp)(s.pos,c,h),f=(0,p.Lp)(r.pos,c,h);(function(e,t,i,s,r,n){(function(e,t,i,s,r,n){let{spatialReference:o}=r;const h=(0,_.IP)(t,i,o,o);if(null==h)return!1;const c=(0,_.IP)(i,s,o,o);if(null==c)return!1;const p=Math.sign(a.uC.shortestSignedDiff(h,c))*Math.PI*.5,g=(0,d.Wq)(h+p,"radians","geographic"),u=(0,l.vt)(),f=n.geodesicDistance(i,s,o);return null!=f&&((0,_.rT)(u,i,o,(0,d.l3)(f,"meters"),g,"geodesic"),(0,q.d)(e,u,i),!0)})(e,t,i,s,r,n)||function(e,t,i){const s=(0,u.Re)(C,(0,p.Xz)(i),(0,p.Xz)(t));(0,q.i)(e,s[1],-s[0],0)}(e,t,i)})(R,f,g,n,h,this._geodesicLengthMeasurementUtils),this._checkForSnappingCandidateAlongProjectedRay(e,t,f,g,R,n,o,h)}_checkForSnappingCandidateAlongProjectedRay(e,t,i,s,r,n,o,h){var a;const{spatialReference:d,pointer:g}=h,f=(0,u.Re)(C,(0,p.Xz)(n),(0,p.Xz)(s)),L=(0,u.Om)(r,f)/(0,u.m3)(r),E=(0,u.Ln)(C,(0,p.Xz)(s),r,L),_=(0,p.de)((0,p.fA)(E[0],E[1],n[2]));if((0,v.pM)(o,(0,x.j)(_,d,c.qt,this.view))>this.squaredProximityThreshold(g)||this.isVertical(_,s,h)||this.isVertical(s,i,h))return;const w=(0,q.b)((0,l.vt)(),s,r,Math.sign(L));t.push(new X.HJ({targetPoint:_,constraint:new z.FX(s,(0,p._7)(w)),previousVertex:i,otherVertex:s,otherVertexType:X.pn.CENTER,selfSnappingType:e,isDraped:"on-the-ground"===(null===(a=h.elevationInfo)||void 0===a?void 0:a.mode)}))}}const C=(0,P.vt)(),R=(0,l.vt)();var k=i(59380);class F extends L{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if("polygon"!==t.editGeometryOperations.data.type||r<2)return s;const{view:n}=this,o=i.vertices[0],h=i.vertices[r-1],a=(0,p.Lp)(o.pos,n,t),d=(0,p.Lp)(h.pos,n,t);return this._processCandidateProposal(a,d,e,t,s),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;if("polyline"===t.editGeometryOperations.data.type&&(0===s.index||s.index===r.vertices.length-1))return i;const{view:n}=this,o=(0,p.Lp)(s.leftEdge.leftVertex.pos,n,t),h=(0,p.Lp)(s.rightEdge.rightVertex.pos,n,t);return this._processCandidateProposal(o,h,e,t,i),i}_processCandidateProposal(e,t,i,s,r){if(!this.exceedsShortLineThreshold(e,t,s))return;const n=(0,u.Cc)(j,(0,p.Xz)(e),(0,p.Xz)(t),.5),o=.5*(0,u.Io)((0,p.Xz)(e),(0,p.Xz)(t)),h=(0,m.Dh)(j,(0,p.Xz)(i),n,o),a=(0,p.de)((0,p.fA)(h[0],h[1],i[2])),{spatialReference:d,pointer:l}=s,g=(0,x.j)(i,d,c.qt,this.view);if((0,v.pM)(g,(0,x.j)(a,d,c.qt,this.view))<this.squaredProximityThreshold(l)){var f;if(this.isVertical(e,a,s)||this.isVertical(a,t,s))return;r.push(new k.R({targetPoint:a,point1:e,point2:t,isDraped:"on-the-ground"===(null===(f=s.elevationInfo)||void 0===f?void 0:f.mode)}))}}}const j=(0,P.vt)();var I=i(99791);let N=class extends r.A{constructor(e){super(e),this.updating=!1,this._snappers=new n.A,this._domain=I.n.SELF}initialize(){this._snappers.push(new y(this.view,this.options),new V(this.view,this.options,this.geodesicLengthMeasurementUtils),new M(this.view,this.options,this.geodesicLengthMeasurementUtils),new F(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t,i){if(!(t&this._domain&&this.options.effectiveSelfEnabled))return[];const s=[];for(const r of this._snappers.items)for(const t of r.snap(e,i))s.push(t);return(0,v.xX)(e,s),s}};(0,s._)([(0,o.MZ)({readOnly:!0})],N.prototype,"updating",void 0),(0,s._)([(0,o.MZ)({constructOnly:!0})],N.prototype,"view",void 0),(0,s._)([(0,o.MZ)({constructOnly:!0})],N.prototype,"geodesicLengthMeasurementUtils",void 0),(0,s._)([(0,o.MZ)()],N.prototype,"options",null),N=(0,s._)([(0,h.$)("esri.views.interactive.snapping.SelfSnappingEngine")],N)}}]);
//# sourceMappingURL=7960.1c3a819a.chunk.js.map