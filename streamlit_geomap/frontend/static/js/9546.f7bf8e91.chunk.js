"use strict";(self.webpackChunkstreamlit_geomap_frontend=self.webpackChunkstreamlit_geomap_frontend||[]).push([[9546],{18153:(e,t,n)=>{n.d(t,{$:()=>c,p:()=>l});var s=n(23862),i=n(80794),o=n(9876),a=n(72317);function r(e){let{x:t,y:n,z:i}=e;return(0,s.fA)(t,n,null!==i&&void 0!==i?i:0)}function c(e,t){switch(e.type){case"edge":return e.draped?new i.X({edgeStart:r(e.start),edgeEnd:r(e.end),targetPoint:(0,s.de)(r(e.target)),objectId:e.objectId,getGroundElevation:t}):new o.z({edgeStart:r(e.start),edgeEnd:r(e.end),targetPoint:(0,s.de)(r(e.target)),objectId:e.objectId,isDraped:!1});case"vertex":return new a.C({targetPoint:(0,s.de)(r(e.target)),objectId:e.objectId,isDraped:!1})}}function l(e,t){return null!=e&&"3d"===e.type?(n,s)=>e.elevationProvider.getElevation(n,s,0,t,"ground"):()=>null}},23241:(e,t,n)=>{n.d(t,{_:()=>o});var s=n(20664),i=n(64753);class o extends i.m{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof o&&(0,s.q)(this.point,e.point)}}},35961:(e,t,n)=>{n.d(t,{n:()=>c});n(81806);var s=n(53521),i=n(87663),o=n(50346),a=n(31633),r=n(59097);function c(){let e=arguments.length>1?arguments[1]:void 0;if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]){const{elevationInfo:t,alignPointsInFeatures:n}=e;return new d(t,n)}return new l}class l{async alignCandidates(e,t,n){return e}notifyElevationSourceChange(){}}class d{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new s.q(1024),this._cacheVersion=0}async alignCandidates(e,t,n){const s=this._elevationInfo;return null==s||"absolute-height"!==s.mode||s.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(function(e,t,n){const{offset:s,unit:i}=n;if(null==s)return;const o=(0,a.G9)(t),c=s*((0,r.Ao)(null!==i&&void 0!==i?i:"meters")/o);for(const a of e)switch(a.type){case"edge":a.start.z+=c,a.end.z+=c;continue;case"vertex":a.target.z+=c;continue}}(e,t,s),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(e,t,n){const s=new Map;for(const o of e)(0,i.tE)(s,o.objectId,p).push(o);const[a,r,c]=this._prepareQuery(s,t),l=await this._alignPointsInFeatures(a,n);if((0,o.Te)(n),c!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t,n);this._applyCacheAndResponse(a,l,r);const{drapedObjectIds:d,failedObjectIds:u}=l,h=[];for(const i of e){const{objectId:e}=i;d.has(e)&&"edge"===i.type&&(i.draped=!0),u.has(e)||h.push(i)}return h}_prepareQuery(e,t){const n=[],s=[];for(const[i,o]of e){const e=[];for(const t of o)this._addToQueriesOrCachedResult(i,t.target,e,s),"edge"===t.type&&(this._addToQueriesOrCachedResult(i,t.start,e,s),this._addToQueriesOrCachedResult(i,t.end,e,s));0!==e.length&&n.push({objectId:i,points:e})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},s,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,s){const i=h(e,t),o=this._alignmentsCache.get(i);null==o?n.push(t):s.push(new u(t,o))}_applyCacheAndResponse(e,t,n){let{elevations:s,drapedObjectIds:i,failedObjectIds:o}=t;for(const c of n)c.apply();let a=0;const r=this._alignmentsCache;for(const{objectId:c,points:l}of e.pointsInFeatures){if(o.has(c)){a+=l.length;continue}const e=!i.has(c);for(const t of l){const n=h(c,t),i=s[a++];t.z=i,e&&r.put(n,i,1)}}}}class u{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}}function h(e,t){let{x:n,y:s,z:i,spatialReference:o}=t;return"".concat(e,"-").concat(n,"-").concat(s,"-").concat(null!==i&&void 0!==i?i:0,"}-wkid:").concat(null===o||void 0===o?void 0:o.wkid)}function p(){return[]}},56002:(e,t,n)=>{function s(e){let t,n,s=[],i=!1;return function(){for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return i&&t===this&&function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(a,s)||(n=e.apply(this,a),t=this,s=a,i=!0),n}}n.d(t,{B:()=>s})},69963:(e,t,n)=>{n.d(t,{H:()=>r});n(81806);var s=n(53084),i=n(53521),o=n(50346),a=n(88685);function r(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?new l(arguments.length>1?arguments[1]:void 0):new c}class c{async fetch(){return[]}notifySymbologyChange(){}}class l{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new i.q(1024),this._cacheVersion=0}async fetch(e,t){if(0===e.length)return[];const n=[],i=[],a=this._candidatesCache;for(const o of e){const e=d(o),t=a.get(e);if(t)for(const n of t)i.push((0,s.o8)(n));else n.push(o),a.put(e,[],1)}if(0===n.length)return i;const r=this._cacheVersion,{candidates:c,sourceCandidateIndices:l}=await this._getSymbologyCandidates(n,t);if((0,o.Te)(t),r!==this._cacheVersion)return this.fetch(e,t);const u=[],{length:h}=c;for(let o=0;o<h;++o){const e=c[o],t=d(n[l[o]]),i=a.get(t);i.push(e),a.put(t,i,i.length),u.push((0,s.o8)(e))}return i.concat(u)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function d(e){switch(e.type){case"vertex":{var t;const{objectId:n,target:s}=e,i="".concat(n,"-vertex-").concat(s.x,"-").concat(s.y,"-").concat(null!==(t=s.z)&&void 0!==t?t:0);return(0,a.Wm)(i).toString()}case"edge":{var n,s;const{objectId:t,start:i,end:o}=e,r="".concat(t,"-edge-").concat(i.x,"-").concat(i.y,"-").concat(null!==(n=i.z)&&void 0!==n?n:0,"-to-").concat(o.x,"-").concat(o.y,"-").concat(null!==(s=o.z)&&void 0!==s?s:0);return(0,a.Wm)(r).toString()}default:return""}}},72317:(e,t,n)=>{n.d(t,{C:()=>r});var s=n(89379),i=n(75543),o=n(61751),a=n(23241);class r extends o.w{constructor(e){super((0,s.A)((0,s.A)({},e),{},{constraint:new i.i7(e.targetPoint)}))}get hints(){return[new a._(this.targetPoint,this.isDraped,this.domain)]}}},74964:(e,t,n)=>{n.d(t,{z:()=>a});n(81806);class s{filter(e,t){return t}notifyElevationSourceChange(){}}class i{filter(e,t){const{point:n,distance:s}=e,{z:i}=n;if(null==i)return t;if(0===t.length)return t;const a=function(e){return"number"==typeof e?{x:e,y:e,z:e}:e}(s),r=this._updateCandidatesTo3D(t,n,a).filter(o);return r.sort(l),r}_updateCandidatesTo3D(e,t,n){for(const s of e)switch(s.type){case"edge":r(s,t,n);continue;case"vertex":c(s,t,n);continue}return e}}function o(e){return e.distance<=1}function a(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?new i:new s}function r(e,t,n){let{x:s,y:i,z:o}=n;const{start:a,end:r,target:c}=e;e.draped||function(e,t,n,s){const i=s.x-n.x,o=s.y-n.y,a=s.z-n.z,r=i*i+o*o+a*a,c=(t.x-n.x)*i+(t.y-n.y)*o+a*(t.z-n.z),l=Math.min(1,Math.max(0,c/r)),d=n.x+i*l,u=n.y+o*l,h=n.z+a*l;e.x=d,e.y=u,e.z=h}(c,t,a,r);const l=(t.x-c.x)/s,d=(t.y-c.y)/i,u=(t.z-c.z)/o;e.distance=Math.sqrt(l*l+d*d+u*u)}function c(e,t,n){let{x:s,y:i,z:o}=n;const{target:a}=e,r=(t.x-a.x)/s,c=(t.y-a.y)/i,l=(t.z-a.z)/o,d=Math.sqrt(r*r+c*c+l*l);e.distance=d}function l(e,t){return e.distance-t.distance}},99546:(e,t,n)=>{n.r(t),n.d(t,{GraphicsSnappingSource:()=>j});var s=n(35143),i=n(91967),o=n(18690),a=n(98773),r=n(56002),c=n(50346),l=n(68134),d=n(46053),u=(n(81806),n(76460),n(85842)),h=n(19451),p=n(65215),y=n(9956),g=n(54222),f=n(31608),_=n(98618),v=n(20176),m=n(78482),w=n(72547),S=n(48094),C=n(1900),b=n(12482),I=n(94439),z=n(70330),x=n(18153),E=n(35961),k=n(74964),A=n(69963),P=n(59752);const M="graphics-collections";let j=class extends i.A{get updating(){return this._updatingHandles.updating}get _hasZ(){const e=this.view;return null!=e&&"3d"===e.type&&"map-notes"!==this.layerSource.layer.type}get _snappingElevationAligner(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;if(!n||"map-notes"===t.type)return(0,E.n)();return(0,E.n)(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:async(n,s)=>(await(0,c.qr)(e.whenLayerView(t),s)).elevationAlignPointsInFeatures(n,s)})}get _snappingElevationFilter(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"map-notes"!==this.layerSource.layer.type;return(0,k.z)(t)}get _symbologySnappingFetcher(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type,s=this._extrudedPolygonSymbolsCount>0;return n&&"map-notes"!==t.type&&s?(0,A.H)(s,async(n,s)=>{const i=await e.whenLayerView(t);return(0,c.Te)(s),i.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},s)}):(0,A.H)()}constructor(e){super(e),this.availability=1,this._sources={multipoint:null,point:null,polygon:null,polyline:null},this._loadedWkids=new Set,this._loadedWkts=new Set,this._pendingAdds=[],this._extrudedPolygonSymbolsCount=0,this._updatingHandles=new h.U,this._memoizedMakeGetGroundElevation=(0,r.B)(x.p)}destroy(){for(const e of this._pendingAdds)e.task.abort();this._pendingAdds.length=0,this._mapSources(e=>this._destroySource(e)),this._updatingHandles.destroy()}initialize(){this._updatingHandles.add(()=>this.getGraphicsLayers(),e=>{this._updatingHandles.removeHandles(M);for(const t of e)this._addMany(t.graphics.toArray()),this.addHandles([t.on("graphic-update",e=>this._onGraphicUpdate(e)),this._updatingHandles.addOnCollectionChange(()=>t.graphics,e=>this._onGraphicsChanged(e))],M)},l.Vh);const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"map-notes"!==t.type&&e.elevationProvider&&this.addHandles([e.elevationProvider.on("elevation-change",e=>{let{context:n}=e;(0,b.Up)(n,t.elevationInfo)&&this._snappingElevationAligner.notifyElevationSourceChange()}),(0,l.wB)(()=>t.elevationInfo,()=>this._snappingElevationAligner.notifyElevationSourceChange(),l.Vh),(0,l.on)(()=>t,["edits","apply-edits","graphic-update"],()=>this._symbologySnappingFetcher.notifySymbologyChange())])}async fetchCandidates(e,t){const{point:n,coordinateHelper:{spatialReference:s}}=e,i=await(0,c.nA)(this._mapSources(n=>this._fetchCandidatesForSource(n,e,t)));(0,c.Te)(t);const o=this._memoizedMakeGetGroundElevation(this.view,s),a=i.flat().map(e=>(0,x.$)(e,o));return(0,z.xX)(n,a),a}async _fetchCandidatesForSource(e,t,n){var s,i;const o=(0,z.nf)({parameters:t,mode:null!==(s=null===(i=this.view)||void 0===i?void 0:i.type)&&void 0!==s?s:"2d"}),a=await(0,m.J)(e.queryEngine,o,n);(0,c.Te)(n);const r=await this._snappingElevationAligner.alignCandidates(a.candidates,t.coordinateHelper.spatialReference,n);(0,c.Te)(n);const l=await this._symbologySnappingFetcher.fetch(r,n);(0,c.Te)(n);const d=0===l.length?r:[...r,...l];return this._snappingElevationFilter.filter(o,d)}refresh(){}_onGraphicUpdate(e){if(this.getGraphicsLayers().some(t=>t.graphics.includes(e.graphic)))switch(e.property){case"geometry":case"visible":this._remove(e.graphic),this._addMany([e.graphic])}}_onGraphicsChanged(e){for(const t of e.removed)this._remove(t);this._addMany(e.added)}_addMany(e){const t=[],n=new Map;for(const s of e)null!=s.geometry&&(this._needsInitializeProjection(s.geometry.spatialReference)?(t.push(s.geometry.spatialReference),n.set(s.uid,s)):this._add(s));this._createPendingAdd(t,n)}_createPendingAdd(e,t){if(!e.length)return;const n=(0,a.UT)(async n=>{await(0,y.initializeProjection)(e.map(e=>({source:e,dest:this.spatialReference})),{signal:n}),this._markLoadedSpatialReferences(e);for(const e of t.values())this._add(e)});this._updatingHandles.addPromise(n.promise);const s={task:n,graphics:t},i=()=>(0,o.Xy)(this._pendingAdds,s);n.promise.then(i,i),this._pendingAdds.push(s)}_markLoadedSpatialReferences(e){for(const t of e){null!=t.wkid&&this._loadedWkids.add(t.wkid);const e=t.wkt2||t.wkt;e&&this._loadedWkts.add(e)}}_add(e){if(null==e.geometry||!e.visible)return;let t=e.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=p.A.fromExtent(t));const n=this._ensureSource(t.type);if(null==n)return;const s=this._createOptimizedFeature(e.uid,t);null!=s&&(n.featureStore.add(s),(0,I.f3)(e.symbol)&&this._extrudedPolygonSymbolsCount++)}_needsInitializeProjection(e){if(null!=e.wkid&&this._loadedWkids.has(e.wkid))return!1;const t=e.wkt2||e.wkt;return(!t||!this._loadedWkts.has(t))&&!(0,y.canProjectWithoutEngine)(e,this.spatialReference)}_createOptimizedFeature(e,t){const n=(0,y.project)((0,g.b3)(t),this.spatialReference);if(!n)return null;const s=this._ensureGeometryHasZ(n),i=(0,_.Ux)(s,this._hasZ,!1);return new v.Om(i,{[F]:e},null,e)}_ensureGeometryHasZ(e){var t;if(!this._hasZ)return e;const n=e=>{for(;e.length<3;)e.push(0)},s=e.clone();switch(s.hasZ=!0,s.type){case"point":s.z=null!==(t=s.z)&&void 0!==t?t:0;break;case"multipoint":s.points.forEach(n);break;case"polyline":s.paths.forEach(e=>e.forEach(n));break;case"polygon":s.rings.forEach(e=>e.forEach(n))}return s}_ensureSource(e){const t=this._sources[e];if(null!=t)return t;const n=this._createSource(e);return this._sources[e]=n,n}_createSource(e){const t=f.gy.toJSON(e),n=this._hasZ,s=new w.A({geometryType:t,hasZ:n,hasM:!1});return{featureStore:s,queryEngine:new S.do({featureStore:s,fieldsIndex:C.A.fromLayerJSON({fields:[{name:F,type:"esriFieldTypeOID",alias:F}]}),geometryType:t,hasM:!1,hasZ:n,featureIdInfo:{type:"object-id",fieldName:F},spatialReference:this.spatialReference,priority:P.W6.SNAPPING,scheduler:null!=this.view&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:e}}_remove(e){this._mapSources(t=>this._removeFromSource(t,e));for(const t of this._pendingAdds)t.graphics.delete(e.uid),0===t.graphics.size&&t.task.abort()}_removeFromSource(e,t){const n=t.uid;e.featureStore.has(n)&&(e.featureStore.removeById(t.uid),(0,I.f3)(t.symbol)&&this._extrudedPolygonSymbolsCount--)}_destroySource(e){e.queryEngine.destroy(),this._sources[e.type]=null}_mapSources(e){const{point:t,polygon:n,polyline:s,multipoint:i}=this._sources,o=[];return null!=t&&o.push(e(t)),null!=n&&o.push(e(n)),null!=s&&o.push(e(s)),null!=i&&o.push(e(i)),o}};(0,s._)([(0,d.MZ)()],j.prototype,"getGraphicsLayers",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],j.prototype,"layerSource",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],j.prototype,"spatialReference",void 0),(0,s._)([(0,d.MZ)({constructOnly:!0})],j.prototype,"view",void 0),(0,s._)([(0,d.MZ)({readOnly:!0})],j.prototype,"updating",null),(0,s._)([(0,d.MZ)({readOnly:!0})],j.prototype,"availability",void 0),(0,s._)([(0,d.MZ)()],j.prototype,"_hasZ",null),(0,s._)([(0,d.MZ)()],j.prototype,"_snappingElevationAligner",null),(0,s._)([(0,d.MZ)()],j.prototype,"_snappingElevationFilter",null),(0,s._)([(0,d.MZ)()],j.prototype,"_symbologySnappingFetcher",null),(0,s._)([(0,d.MZ)()],j.prototype,"_extrudedPolygonSymbolsCount",void 0),j=(0,s._)([(0,u.$)("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],j);const F="OBJECTID"}}]);
//# sourceMappingURL=9546.f7bf8e91.chunk.js.map